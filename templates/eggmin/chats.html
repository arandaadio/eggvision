{% extends "eggmin/base.html" %}
{% block title %}Chats · EggMin{% endblock %}

{% block header_title %}Pusat Pesan{% endblock %}
{% block header_subtitle %}Kelola percakapan dan bantuan langsung dengan pengguna.{% endblock %}

{% block content %}
    <div class="flex flex-col lg:flex-row h-[calc(100vh-13rem)] bg-white dark:bg-[#161616] rounded-2xl border border-gray-200 dark:border-gray-800 shadow-sm overflow-hidden relative">
        
        <div id="chat-sidebar" class="w-full lg:w-80 xl:w-96 border-b lg:border-b-0 lg:border-r border-gray-200 dark:border-gray-800 flex flex-col bg-gray-50/50 dark:bg-[#1a1a1a] h-full transition-all duration-300">
            
            <div class="p-3 border-b border-gray-200 dark:border-gray-800 space-y-3 flex-shrink-0">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="searchInput" placeholder="Cari nama/email..." 
                           value="{{ current_filters.q }}"
                           onkeypress="handleSearch(event)"
                           class="w-full pl-9 pr-4 py-2 bg-white dark:bg-[#111] border border-gray-200 dark:border-gray-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all placeholder-gray-500 dark:text-white">
                </div>
                
                <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                    <select id="roleFilter" onchange="applyFilters()" class="bg-white dark:bg-[#111] border border-gray-200 dark:border-gray-700 text-xs rounded-lg px-2 py-1.5 focus:outline-none dark:text-gray-300">
                        <option value="all" {% if current_filters.role == 'all' %}selected{% endif %}>Semua Role</option>
                        <option value="pembeli" {% if current_filters.role == 'pembeli' %}selected{% endif %}>Pembeli</option>
                        <option value="pengusaha" {% if current_filters.role == 'pengusaha' %}selected{% endif %}>Pengusaha</option>
                        <option value="guest" {% if current_filters.role == 'guest' %}selected{% endif %}>Guest</option>
                    </select>

                    <select id="statusFilter" onchange="applyFilters()" class="bg-white dark:bg-[#111] border border-gray-200 dark:border-gray-700 text-xs rounded-lg px-2 py-1.5 focus:outline-none dark:text-gray-300">
                        <option value="all" {% if current_filters.status == 'all' %}selected{% endif %}>Semua Status</option>
                        <option value="unread" {% if current_filters.status == 'unread' %}selected{% endif %}>Belum Dibaca</option>
                        <option value="archived" {% if current_filters.status == 'archived' %}selected{% endif %}>Diarsipkan</option>
                    </select>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto" id="conversation-list">
                {% if conversations %}
                    {% for chat in conversations %}
                    <div class="conversation-item relative w-full border-b border-gray-100 dark:border-gray-800/50 group hover:bg-white dark:hover:bg-[#222] transition-all cursor-pointer"
                         onclick="loadChat('{{ chat.conversation_id }}', '{{ chat.name }}', '{{ chat.email }}', '{{ chat.role }}')"
                         data-id="{{ chat.conversation_id }}">
                        
                        <div class="active-indicator hidden absolute left-0 top-0 bottom-0 w-1 bg-primary"></div>

                        <div class="p-4 flex items-start gap-3">
                            <div class="relative flex-shrink-0">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ chat.name|lower|replace(' ', '') }}" 
                                     class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 object-cover border border-gray-200 dark:border-gray-600">
                                
                                {% if chat.is_pinned %}
                                    <div class="absolute -top-1 -left-1 bg-yellow-500 text-black p-0.5 rounded-full border border-white dark:border-black shadow-sm z-10" title="Pinned">
                                        <i data-lucide="pin" class="w-2.5 h-2.5 fill-current"></i>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-baseline mb-1">
                                    <h4 class="font-bold text-sm truncate text-gray-900 dark:text-white">{{ chat.name }}</h4>
                                </div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 truncate group-hover:text-gray-700 dark:group-hover:text-gray-300 transition-colors line-clamp-1 pr-6">
                                    {{ chat.last_message }}
                                </p>
                                <div class="flex items-center gap-2 mt-2">
                                    <span class="text-[10px] font-mono text-gray-500 dark:text-gray-400">
                                        {{ chat.last_message_time.strftime('%H:%M') }}
                                    </span>
                                    <span class="text-[10px] text-gray-300 dark:text-gray-600">•</span>
                                    <span class="text-[10px] px-2 py-0.5 rounded-md border capitalize font-medium
                                        {{ 'bg-blue-50 text-blue-600 border-blue-100 dark:bg-blue-900/20 dark:text-blue-400 dark:border-blue-900' if chat.role == 'pembeli' else 
                                           'bg-amber-50 text-amber-600 border-amber-100 dark:bg-amber-900/20 dark:text-amber-400 dark:border-amber-900' if chat.role == 'pengusaha' else 
                                           'bg-gray-100 text-gray-600 border-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700' }}">
                                        {{ chat.role }}
                                    </span>
                                    {% if chat.unread_count > 0 %}
                                    <span class="ml-auto bg-red-500 text-white text-[10px] font-bold px-1.5 min-w-[1.25rem] h-5 rounded-full flex items-center justify-center shadow-sm">
                                        {{ chat.unread_count }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="absolute right-2 top-3 lg:opacity-0 group-hover:opacity-100 transition-opacity z-20" onclick="event.stopPropagation()">
                                <div class="relative" x-data="{ open: false }">
                                    <button @click="open = !open" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500">
                                        <i data-lucide="more-vertical" class="w-4 h-4"></i>
                                    </button>
                                    <div x-show="open" @click.away="open = false" 
                                         class="absolute right-0 mt-1 w-32 bg-white dark:bg-[#222] border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg py-1 z-50"
                                         style="display: none;">
                                        <button onclick="chatAction('pin', '{{ chat.conversation_id }}')" class="flex items-center gap-2 w-full px-3 py-2 text-xs hover:bg-gray-50 dark:hover:bg-white/5 text-left">
                                            <i data-lucide="pin" class="w-3 h-3"></i> {{ 'Unpin' if chat.is_pinned else 'Pin Chat' }}
                                        </button>
                                        <button onclick="chatAction('archive', '{{ chat.conversation_id }}')" class="flex items-center gap-2 w-full px-3 py-2 text-xs hover:bg-gray-50 dark:hover:bg-white/5 text-left">
                                            <i data-lucide="archive" class="w-3 h-3"></i> {{ 'Unarchive' if chat.is_archived else 'Arsipkan' }}
                                        </button>
                                        <div class="h-px bg-gray-100 dark:bg-gray-700 my-1"></div>
                                        <button onclick="chatAction('delete', '{{ chat.conversation_id }}')" class="flex items-center gap-2 w-full px-3 py-2 text-xs hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 text-left">
                                            <i data-lucide="trash-2" class="w-3 h-3"></i> Hapus
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="flex flex-col items-center justify-center h-64 text-center px-4">
                        <div class="w-12 h-12 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-3 text-gray-400">
                            <i data-lucide="inbox" class="w-6 h-6"></i>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-medium">Tidak ada chat</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div id="main-chat-area" class="flex-1 flex-col bg-white dark:bg-[#161616] relative h-full hidden lg:flex">
            
            <div id="chat-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 z-10 bg-white dark:bg-[#161616]">
                <div class="w-24 h-24 bg-gray-50 dark:bg-[#1a1a1a] rounded-full flex items-center justify-center mb-6 animate-pulse border border-gray-100 dark:border-gray-800">
                    <i data-lucide="message-circle" class="w-10 h-10 text-primary"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white font-canela">EggVision Chat Admin</h3>
                <p class="text-gray-500 dark:text-gray-400 mt-2 max-w-md">
                    Pilih percakapan dari daftar untuk melihat detail.
                </p>
            </div>

            <div id="active-chat-container" class="flex-1 flex flex-col h-full hidden opacity-0 transition-opacity duration-300">
                
                <div class="h-16 px-4 lg:px-6 border-b border-gray-200 dark:border-gray-800 flex items-center gap-3 bg-white/80 dark:bg-[#161616]/80 backdrop-blur-sm sticky top-0 z-20">
                    <button onclick="closeChat()" class="lg:hidden p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 text-gray-600 dark:text-gray-300">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>

                    <img id="header-avatar" src="" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 object-cover border border-gray-200 dark:border-gray-700">
                    
                    <div class="flex-1 min-w-0">
                        <h3 id="header-name" class="font-bold text-gray-900 dark:text-white leading-tight truncate">User Name</h3>
                        <p id="header-email" class="text-xs text-gray-500 dark:text-gray-400 font-mono truncate">user@email.com</p>
                    </div>

                    <div class="flex items-center gap-1">
                        <button onclick="chatAction('archive', currentConversationId)" class="p-2 hover:bg-gray-100 dark:hover:bg-white/5 text-gray-400 hover:text-gray-600 rounded-lg transition-colors" title="Arsipkan">
                            <i data-lucide="archive" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="messages-area" class="flex-1 overflow-y-auto p-4 lg:p-6 space-y-4 bg-gray-50/30 dark:bg-black/20 scroll-smooth"></div>

                <div class="p-4 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#161616]">
                    <form id="reply-form" onsubmit="submitReply(event)" class="flex items-end gap-2 max-w-4xl mx-auto">
                        <div class="flex-1 bg-gray-100 dark:bg-[#1a1a1a] rounded-2xl border border-transparent focus-within:border-primary focus-within:ring-1 focus-within:ring-primary/50 transition-all">
                            <textarea id="reply-input" rows="1" 
                                      class="w-full bg-transparent px-4 py-3 text-sm text-gray-900 dark:text-white focus:outline-none resize-none max-h-32 placeholder-gray-500"
                                      placeholder="Tulis balasan..."
                                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                        </div>
                        <button type="submit" class="bg-primary hover:bg-yellow-500 text-black p-3 rounded-full shadow-lg shadow-yellow-500/20 transition-transform hover:scale-105 active:scale-95 flex-shrink-0">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
  let currentConversationId = null;
  let lastMessageId = null;
  let adminPollingInterval = null;

  // --- MOBILE VIEW LOGIC ---
  function showChatMobile() {
      // Hide sidebar list, show main chat
      document.getElementById('chat-sidebar').classList.add('hidden', 'lg:flex');
      document.getElementById('main-chat-area').classList.remove('hidden');
      document.getElementById('main-chat-area').classList.add('flex');
  }

  function closeChat() {
      // Show sidebar list, hide main chat
      document.getElementById('chat-sidebar').classList.remove('hidden', 'lg:flex');
      document.getElementById('main-chat-area').classList.add('hidden');
      document.getElementById('main-chat-area').classList.remove('flex');
      
      // Reset state
      currentConversationId = null;
      if (adminPollingInterval) clearInterval(adminPollingInterval);
      
      // Reset highlighting in desktop view
      document.querySelectorAll('.conversation-item').forEach(el => {
          el.classList.remove('bg-white', 'dark:bg-[#1a1a1a]', 'shadow-sm');
          el.classList.add('hover:bg-white');
          const indicator = el.querySelector('.active-indicator');
          if(indicator) indicator.classList.add('hidden');
      });
  }

  // --- FILTERING & ACTIONS (Same as before) ---
  function applyFilters() {
      const role = document.getElementById('roleFilter').value;
      const status = document.getElementById('statusFilter').value;
      const query = document.getElementById('searchInput').value;
      const url = new URL(window.location.href);
      url.searchParams.set('role', role);
      url.searchParams.set('status', status);
      url.searchParams.set('q', query);
      window.location.href = url.toString();
  }

  function handleSearch(e) { if (e.key === 'Enter') applyFilters(); }

  function chatAction(action, id) {
      if (action === 'delete' && !confirm("Hapus percakapan ini secara permanen?")) return;
      fetch(`/eggmin/api/chats/action/${action}/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.success) window.location.reload();
            else alert('Error: ' + data.error);
        });
  }

  // --- LOAD CHAT ---
  function loadChat(convId, name, email, role) {
      currentConversationId = convId;

      // Handle UI transitions
      if (window.innerWidth < 1024) {
          showChatMobile(); // Mobile specific transition
      }
      
      // General UI cleanup
      document.getElementById('chat-placeholder').classList.add('hidden');
      const chatContainer = document.getElementById('active-chat-container');
      chatContainer.classList.remove('hidden');
      setTimeout(() => chatContainer.classList.remove('opacity-0'), 50);

      // Set Header Info
      document.getElementById('header-name').textContent = name;
      document.getElementById('header-email').textContent = email;
      document.getElementById('header-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${name.toLowerCase().replace(' ', '')}`;

      // Highlight Active Item (Desktop Visuals)
      document.querySelectorAll('.conversation-item').forEach(el => {
          const indicator = el.querySelector('.active-indicator');
          if(el.dataset.id === convId) {
              el.classList.add('bg-white', 'dark:bg-[#1a1a1a]', 'shadow-sm');
              el.classList.remove('hover:bg-white');
              if(indicator) indicator.classList.remove('hidden');
          } else {
              el.classList.remove('bg-white', 'dark:bg-[#1a1a1a]', 'shadow-sm');
              el.classList.add('hover:bg-white');
              if(indicator) indicator.classList.add('hidden');
          }
      });

      // Polling Logic
      if (adminPollingInterval) clearInterval(adminPollingInterval);
      fetchMessages(convId, true);
      adminPollingInterval = setInterval(() => fetchMessages(convId, false), 3000);
  }

  // --- FETCH & RENDER MESSAGES ---
  function fetchMessages(convId, showLoading=true) {
      const messagesArea = document.getElementById('messages-area');
      if(showLoading) messagesArea.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>';

      fetch(`/eggmin/api/chats/history/${convId}`)
          .then(res => res.json())
          .then(data => {
              if(data.success) {
                  renderMessages(data.messages, showLoading);
                  if(data.messages.length > 0) lastMessageId = data.messages[data.messages.length - 1].id;
              }
          });
  }

  function renderMessages(messages, isFirstLoad) {
      const container = document.getElementById('messages-area');
      const isNearBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
      container.innerHTML = ''; 
      let lastDate = null;

      messages.forEach(msg => {
          const parts = msg.created_at.split(' ');
          const msgDate = parts[0] + ' ' + parts[1] + ' ' + parts[2];
          const timeString = parts[3] || "";

          if (msgDate !== lastDate) {
              container.innerHTML += `<div class="flex justify-center my-6"><span class="text-[10px] font-bold bg-gray-200 dark:bg-gray-800 px-3 py-1 rounded-full text-gray-500 dark:text-gray-400 uppercase tracking-wide">${msgDate}</span></div>`;
              lastDate = msgDate;
          }

          const isMe = msg.message_type.startsWith('admin_to');
          const alignment = isMe ? 'justify-end' : 'justify-start';
          const bubbleColor = isMe ? 'bg-primary text-black rounded-br-none shadow-md shadow-primary/10' : 'bg-white dark:bg-[#262626] border border-gray-200 dark:border-gray-700 rounded-bl-none shadow-sm text-gray-800 dark:text-gray-200';
          const timeColor = isMe ? 'text-black/60' : 'text-gray-400';

          const html = `
              <div class="flex ${alignment} mb-4 group animate-in fade-in slide-in-from-bottom-2 duration-300">
                  <div class="max-w-[85%] lg:max-w-[75%]">
                      <div class="${bubbleColor} px-5 py-3 rounded-2xl relative">
                          <p class="text-sm leading-relaxed whitespace-pre-wrap">${msg.message}</p>
                          <div class="flex items-center justify-end gap-1.5 mt-1.5">
                              <span class="text-[10px] font-medium ${timeColor}">${timeString}</span>
                              ${isMe ? `<i data-lucide="check-check" class="w-3 h-3 ${timeColor}"></i>` : ''}
                          </div>
                      </div>
                  </div>
              </div>`;
          container.innerHTML += html;
      });

      if (isFirstLoad || isNearBottom) container.scrollTop = container.scrollHeight;
      if(typeof lucide !== 'undefined') lucide.createIcons();
  }

  function submitReply(e) {
      e.preventDefault();
      const input = document.getElementById('reply-input');
      const message = input.value.trim();
      if(!message || !currentConversationId) return;

      const formData = new FormData();
      formData.append('message', message);

      fetch(`/eggmin/api/chats/reply/${currentConversationId}`, { method: 'POST', body: formData })
      .then(res => res.json())
      .then(data => {
          if(data.success) {
              input.value = '';
              fetchMessages(currentConversationId, false);
          } else alert('Error: ' + data.error);
      });
  }

  document.getElementById('reply-input').addEventListener('keydown', function(e) {
      if(e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          submitReply(e);
      }
  });
</script>
{% endblock %}