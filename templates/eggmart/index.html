{% extends "eggmart/base.html" %}
{% block title %}Dashboard · EggMin{% endblock %}

{% block body %}
<div class="min-h-screen bg-background">
  <aside class="fixed left-0 top-0 h-screen w-[130px] bg-sidebar border-r border-sidebar-border flex flex-col">
    <div class="p-6 border-b border-sidebar-border">
      <div class="flex flex-col items-center gap-2">
        <div class="w-12 h-12 rounded-full bg-premium-gold flex items-center justify-center">
          <div class="text-primary-black font-bold text-xs">EM</div>
        </div>
        <span class="text-premium-gold text-sm font-semibold">EGGMART</span>
      </div>
    </div>

    <nav class="flex-1 py-4">
    {% if current_user.role == 'pengusaha' %}
      {% set menu = [
        {"id":"dashboard", "icon":"layout-dashboard", "label":"Dashboard", "href":url_for('eggmart_controller.eggmartDashboard')},
        {"id":"history",   "icon":"history",          "label":"History", "href":url_for('eggmart_controller.eggmartHistory')},
        {"id":"eggmonitor","icon":"scan",             "label":"EggMonitor", "href":"/eggmonitor/index"}
      ] %}
    {% elif current_user.role == 'pembeli' %}
      {% set menu = [
        {"id":"catalog", "icon":"egg",     "label":"Catalog", "href":url_for('eggmart_controller.eggmart')},
        {"id":"history", "icon":"history", "label":"History", "href":url_for('eggmart_controller.eggmartHistory')}
      ] %}
    {% else %}
      {% set menu = [
        {"id":"dashboard","icon":"layout-dashboard","label":"Dashboard","href":url_for('eggmart_controller.eggmartDashboard')},
        {"id":"catalog", "icon":"egg",            "label":"Catalog",   "href":url_for('eggmart_controller.eggmart')},
        {"id":"history", "icon":"history",        "label":"History","href":url_for('eggmart_controller.eggmartHistory')}
      ] %}
    {% endif %}

      {% for item in menu %}
        {% set is_active = (item.id == active_menu) %}
        <a href="{{ item.href }}"
           class="w-full px-4 py-4 flex flex-col items-center gap-2 transition-colors
           {{ 'text-sidebar-accent-foreground bg-sidebar-accent' if is_active else 'text-sidebar-foreground hover:text-sidebar-accent-foreground hover:bg-sidebar-accent/50' }}">
          <i data-lucide="{{ item.icon }}" class="w-6 h-6"></i>
          <span class="text-xs">{{ item.label }}</span>
        </a>
      {% endfor %}
    </nav>

    <div class="p-4 border-t border-sidebar-border">
      <div class="w-full flex flex-col items-center gap-2 text-sidebar-foreground">
        <div class="w-10 h-10 rounded-full bg-muted overflow-hidden">
          <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=admin" alt="Profile" class="w-full h-full object-cover" />
        </div>
        <span class="text-xs">{{current_user.role}}</span>
      </div>
    </div>
  </aside>

  <main class="ml-[130px] p-8">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-4xl font-bold mb-1">Admin Dashboard</h1>
        <p class="text-muted-foreground">Overview Sistem EggVision</p>
      </div>

      <div class="flex items-center gap-8">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full bg-muted overflow-hidden">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=admin" alt="Admin" class="w-full h-full object-cover" />
          </div>
          <div>
            <div class="text-sm font-semibold">{{ current_user.name }}</div>
            <div class="text-xs text-muted-foreground">{{ current_user.role }}</div>
          </div>
        </div>

        <div class="flex items-center gap-4 text-sm">
          <div class="flex items-center gap-2">
            <i data-lucide="calendar" class="w-4 h-4 text-muted-foreground"></i>
            <span id="live-date">{{ now.strftime('%d/%b/%Y') if now else '' }}</span>
          </div>
          <div class="flex items-center gap-2">
            <i data-lucide="clock" class="w-4 h-4 text-muted-foreground"></i>
            <span id="live-time">{{ now.strftime('%H:%M:%S') if now else '' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-8">
      <div class="flex flex-col xl:flex-row gap-8">
        <section class="flex-1 space-y-8">
          
          <div class="p-6 rounded-xl border bg-gradient-to-br from-primary/30 via-primary/20 to-primary/10 border-primary/30">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h2 class="text-xl font-semibold text-foreground mb-2">
                  Selamat Datang, {{ current_user.name or 'OptikDio' }}
                </h2>
              </div>
              <div class="bg-card px-4 py-2 rounded-lg border border-border">
                <span class="text-sm font-semibold text-primary">EggMart</span>
              </div>
            </div>
          </div>

          <div class="p-6 rounded-xl border bg-card">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h2 class="text-lg font-semibold text-foreground">Kelola Listing EggMart</h2>
                <p class="text-xs text-muted-foreground">
                  Stok per butir, diambil dari hasil scan dengan status <code>available</code>.
                </p>
              </div>
            </div>

            {# ==== FLASH MESSAGE ==== #}
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div class="mb-4 space-y-2">
                  {% for category, message in messages %}
                    {% set base = 'flex items-center gap-2 px-3 py-2 rounded-md border text-xs' %}
                    {% if category == 'success' %}
                      {% set cls = base + ' border-success/40 bg-success/10 text-success' %}
                    {% elif category == 'error' %}
                      {% set cls = base + ' border-destructive/40 bg-destructive/10 text-destructive' %}
                    {% else %}
                      {% set cls = base + ' border-info/40 bg-info/10 text-info' %}
                    {% endif %}
                    <div class="{{ cls }}">
                      <span>{{ message }}</span>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            {% if available_by_grade %}
              <div class="mb-4 text-xs text-muted-foreground">
                Telur siap dijual (belum di-list):
                {% for g, qty in available_by_grade.items() %}
                  <span class="inline-flex items-center rounded-full bg-muted px-2 py-0.5 border mr-2">
                    Grade {{ g }}: {{ qty }} butir
                  </span>
                {% endfor %}
              </div>
            {% else %}
              <p class="mb-4 text-xs text-muted-foreground">
                Belum ada telur dengan status <code>available</code> dari hasil scan.
              </p>
            {% endif %}

            <form action="{{ url_for('eggmart_controller.save_listing') }}" method="POST"
                  class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-6">
              <div>
                <label class="block text-xs mb-1">Grade</label>
                <select name="grade" class="w-full text-sm px-3 py-2 rounded-md border bg-background">
                  {% for g in ['A','B','C'] %}
                    <option value="{{ g }}">Grade {{ g }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-xs mb-1">Harga per butir (Rp)</label>
                <input type="number" name="price" required class="w-full text-sm px-3 py-2 rounded-md border bg-background" placeholder="cth: 1500">
              </div>
              <div>
                <label class="block text-xs mb-1">Stok (butir)</label>
                <input type="number" name="stock" min="1" required class="w-full text-sm px-3 py-2 rounded-md border bg-background" placeholder="cth: 30">
              </div>
              <div class="flex gap-2">
                <button type="submit" class="flex-1 inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground px-3 py-2 text-sm font-medium hover:bg-primary/90">
                  Simpan Listing
                </button>
              </div>
            </form>

            <h3 class="text-sm font-semibold mb-2">Listing Aktif</h3>
            <div class="border border-border rounded-lg overflow-hidden">
              <table class="w-full text-sm">
                <thead class="bg-muted">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground">Grade</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground">Harga/Butir</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground">Stok (butir)</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% if listings %}
                    {% for l in listings %}
                    <tr class="border-t border-border">
                      <td class="px-3 py-2">Grade {{ l.grade }}</td>
                      <td class="px-3 py-2">Rp {{ "{:,.0f}".format(l.price) }}</td>
                      <td class="px-3 py-2">{{ l.stock }}</td>
                      <td class="px-3 py-2">
                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs border
                          {{ 'bg-success/10 text-success border-success/40' if l.status == 'active' else 'bg-muted text-muted-foreground border-border' }}">
                          {{ l.status }}
                        </span>
                      </td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="4" class="px-3 py-3 text-xs text-muted-foreground">
                        Belum ada listing aktif. Tambahkan harga & stok di form di atas.
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <section>
            <div class="inline-flex rounded-lg bg-card border border-border overflow-hidden">
              <button type="button" class="egg-tab-trigger px-4 py-2 text-sm font-medium border-r border-border bg-primary text-primary-foreground" data-tab-target="today">Today</button>
              <button type="button" class="egg-tab-trigger px-4 py-2 text-sm font-medium text-muted-foreground hover:bg-muted" data-tab-target="7days">7 Days</button>
              <button type="button" class="egg-tab-trigger px-4 py-2 text-sm font-medium text-muted-foreground hover:bg-muted" data-tab-target="30days">30 Days</button>
              <button type="button" class="egg-tab-trigger px-4 py-2 text-sm font-medium text-muted-foreground hover:bg-muted" data-tab-target="90days">90 Days</button>
            </div>

            <div class="mt-6 space-y-6">
              <div class="egg-tab-content space-y-6" data-tab-content="today">
                  <div class="p-6 rounded-xl border bg-gradient-to-br from-primary/20 to-primary/5 border-primary/20">
                    <div class="flex items-start justify-between mb-4">
                      <p class="text-sm text-muted-foreground font-medium">Produk Terjual</p>
                      <i data-lucide="shopping-cart" class="w-5 h-5 text-primary"></i>
                    </div>
                    <div class="flex items-end justify-between">
                      <h3 class="text-3xl font-bold text-foreground">{{ cards.today.sold_eggs or 0 }}</h3>
                      <span class="text-xs font-semibold text-muted-foreground">butir terjual hari ini</span>
                    </div>
                  </div>
                  <div class="p-6 rounded-xl border bg-gradient-to-br from-primary/20 to-primary/5 border-primary/20">
                    <div class="flex items-start justify-between mb-4">
                      <p class="text-sm text-muted-foreground font-medium">Transaksi Selesai</p>
                      <i data-lucide="trending-up" class="w-5 h-5 text-primary"></i>
                    </div>
                    <div class="flex items-end justify-between">
                      <h3 class="text-3xl font-bold text-foreground">{{ cards.today.completed_orders or 0 }}</h3>
                      <span class="text-xs font-semibold text-muted-foreground">order selesai hari ini</span>
                    </div>
                  </div>
                  <div class="p-6 rounded-xl border bg-gradient-to-br from-primary/20 to-primary/5 border-primary/20">
                    <div class="flex items-start justify-between mb-4">
                      <p class="text-sm text-muted-foreground font-medium">Performa Chat</p>
                      <i data-lucide="package" class="w-5 h-5 text-primary"></i>
                    </div>
                    <div class="flex items-end justify-between">
                      <h3 class="text-3xl font-bold text-foreground">{{ chat_response_rate or 0 }}%</h3>
                      <span class="text-xs font-semibold text-muted-foreground">sesi terbalas</span>
                    </div>
                  </div>
                  <div class="p-6 rounded-xl border bg-gradient-to-br from-primary/20 to-primary/5 border-primary/20">
                    <div class="flex items-start justify-between mb-4">
                      <p class="text-sm text-muted-foreground font-medium">Penilaian Toko</p>
                      <i data-lucide="star" class="w-5 h-5 text-primary"></i>
                    </div>
                    <div class="flex items-end justify-between">
                      <h3 class="text-3xl font-bold text-foreground">{{ '%.1f'|format(store_rating.avg_rating or 0) }}</h3>
                      <span class="text-xs font-semibold text-muted-foreground">{{ store_rating.total_reviews or 0 }} penilaian</span>
                    </div>
                  </div>
              </div>

              <div class="egg-tab-content hidden rounded-xl border bg-card p-6 text-sm text-muted-foreground" data-tab-content="7days">Ringkasan data 7 hari.</div>
              <div class="egg-tab-content hidden rounded-xl border bg-card p-6 text-sm text-muted-foreground" data-tab-content="30days">Ringkasan data 30 hari.</div>
              <div class="egg-tab-content hidden rounded-xl border bg-card p-6 text-sm text-muted-foreground" data-tab-content="90days">Ringkasan data 90 hari.</div>
            </div>
          </section>
        </section>

        <aside class="w-full xl:w-96">
          <div class="h-full max-h-[600px] xl:max-h-none rounded-xl border bg-card flex flex-col">
            
            <div id="chatListView" class="flex-1 flex flex-col">
              <div class="p-4 border-b border-border">
                <div class="flex items-center gap-2 mb-2">
                  <i data-lucide="message-circle" class="w-5 h-5 text-primary"></i>
                  <h3 class="font-semibold text-foreground">Chat</h3>
                </div>
                <p class="text-sm text-muted-foreground">
                  <span id="totalUnreadLabel">{{ total_unread_chats }}</span> pesan belum dibaca
                </p>
              </div>

              <div class="flex-1 overflow-y-auto">
                <div id="chatListContainer" class="p-2 space-y-1">
                  {# Render awal server-side untuk menghindari layout shift / blank #}
                  {% if chat_threads %}
                    {% for t in chat_threads %}
                      <button type="button"
                              class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-muted/50 cursor-pointer transition-colors chat-thread-item"
                              data-chat-id="{{ t.id }}"
                              data-name="{{ t.name }}"
                              data-initials="{{ t.initials }}"
                              data-fetch-url="{{ url_for('eggmart_controller.seller_chat_thread', session_id=t.id) }}">
                        <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary text-sm font-semibold">
                          {{ t.initials }}
                        </div>
                        <div class="flex-1 min-w-0 text-left">
                          <div class="flex items-center justify-between mb-1">
                            <p class="font-medium text-sm text-foreground truncate">{{ t.name }}</p>
                            <span class="text-xs text-muted-foreground">{{ t.last_time.strftime('%H:%M') if t.last_time }}</span>
                          </div>
                          <p class="text-xs text-muted-foreground truncate">{{ t.last_message or 'Belum ada pesan' }}</p>
                        </div>
                        {% if t.unread > 0 %}
                          <span class="inline-flex items-center justify-center rounded-full bg-primary text-primary-foreground text-xs px-2 py-0.5 font-medium">
                            {{ t.unread }}
                          </span>
                        {% endif %}
                      </button>
                    {% endfor %}
                  {% else %}
                    <p class="px-3 py-4 text-xs text-muted-foreground">Belum ada sesi chat.</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <div id="chatDetailView" class="hidden flex-1 flex-col">
              <div class="p-4 border-b border-border flex items-center gap-3">
                <button type="button" id="backToListBtn" class="mr-2 rounded-md px-2 py-1 text-sm text-muted-foreground hover:bg-muted">←</button>
                <div id="chatDetailAvatar" class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary text-sm font-semibold"></div>
                <div>
                  <p id="chatDetailName" class="font-semibold text-foreground">Nama Pembeli</p>
                  <p id="chatDetailStatus" class="text-xs text-muted-foreground">Online</p>
                </div>
              </div>

              <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

              <div class="p-4 border-t border-border">
                <form id="chatForm" class="flex gap-2">
                  <input id="chatInput" type="text" autocomplete="off" placeholder="Ketik pesan..."
                         class="flex-1 text-sm px-3 py-2 rounded-md border bg-background outline-none focus:ring-2 focus:ring-primary" />
                  <button type="submit" class="inline-flex items-center justify-center rounded-md px-3 py-2 bg-primary text-primary-foreground text-sm hover:bg-primary/90">
                    <i data-lucide="send" class="w-4 h-4"></i>
                  </button>
                </form>
              </div>
            </div>

          </div>
        </aside>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ================== TAB LOGIC & CHART (SAMA SEPERTI SEBELUMNYA) ==================
    const tabTriggers = document.querySelectorAll('.egg-tab-trigger');
    const tabContents = document.querySelectorAll('.egg-tab-content');
    tabTriggers.forEach(function (trigger) {
      trigger.addEventListener('click', function () {
        const target = this.dataset.tabTarget;
        tabTriggers.forEach(btn => {
          btn.classList.remove('bg-primary', 'text-primary-foreground');
          btn.classList.add('text-muted-foreground');
        });
        this.classList.add('bg-primary', 'text-primary-foreground');
        this.classList.remove('text-muted-foreground');
        tabContents.forEach(c => c.dataset.tabContent === target ? c.classList.remove('hidden') : c.classList.add('hidden'));
      });
    });

    const salesCanvas = document.getElementById('salesChart');
    if (salesCanvas && window.Chart) {
      const ctx = salesCanvas.getContext('2d');
      const labels = {{ sales_chart_labels|tojson }};
      const datasetData = {{ sales_chart_data|tojson }};
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            data: datasetData,
            borderColor: 'rgb(59,130,246)',
            backgroundColor: 'transparent',
            fill: false,
            tension: 0.4,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { grid: { color: 'rgba(148,163,184,0.2)' } }
          }
        }
      });
    }

    // ================== REALTIME CHAT SYSTEM (FULL) ==================
    const chatListContainer = document.getElementById('chatListContainer');
    const listView = document.getElementById('chatListView');
    const detailView = document.getElementById('chatDetailView');
    const detailName = document.getElementById('chatDetailName');
    const detailAvatar = document.getElementById('chatDetailAvatar');
    const messagesContainer = document.getElementById('chatMessages');
    const backBtn = document.getElementById('backToListBtn');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const unreadLabel = document.getElementById('totalUnreadLabel');

    const API_THREAD_LIST_URL = "{{ url_for('eggmart_controller.api_get_chat_threads') }}";

    // State Variables
    let activeChatId = null;
    let activeChatApiUrl = null;
    
    // Interval ID untuk Polling
    let listPollingInterval = null;
    let detailPollingInterval = null;

    // Set untuk melacak pesan yang sudah dirender (Mencegah Duplikat)
    let renderedMessageIds = new Set();

    // ---------------- HELPER: RENDER BUBBLE PESAN ----------------
    function appendMessageBubble(msg, scrollToBottom = true) {
      // Cek apakah pesan ini sudah ada di layar?
      // Kita pakai msg.id dari database. Jika msg.id null (saat kirim baru), kita pakai timestamp sementara
      const msgId = msg.id || 'temp-' + Date.now();
      
      if (renderedMessageIds.has(msgId)) return; // Skip jika sudah ada
      renderedMessageIds.add(msgId);

      const isSelf = msg.sender === 'seller';
      const wrapper = document.createElement('div');
      wrapper.className = 'flex ' + (isSelf ? 'justify-end' : 'justify-start');
      
      const bubble = document.createElement('div');
      bubble.className = 'max-w-[70%] rounded-lg p-3 text-sm ' +
        (isSelf ? 'bg-primary text-primary-foreground' : 'bg-muted text-foreground');

      const textEl = document.createElement('p');
      textEl.textContent = msg.text;
      
      const timeEl = document.createElement('p');
      timeEl.className = 'text-xs mt-1 ' + (isSelf ? 'text-primary-foreground/70' : 'text-muted-foreground');
      timeEl.textContent = msg.time || '';

      bubble.appendChild(textEl);
      bubble.appendChild(timeEl);
      wrapper.appendChild(bubble);
      messagesContainer.appendChild(wrapper);

      if (scrollToBottom) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }

    // ---------------- LOGIC 1: SIDEBAR LIST (THREADS) ----------------
    function renderChatList(threads) {
      if (!threads || threads.length === 0) {
        chatListContainer.innerHTML = '<p class="px-3 py-4 text-xs text-muted-foreground">Belum ada sesi chat.</p>';
        return;
      }
      
      const html = threads.map(t => {
        const isActive = (String(t.id) === String(activeChatId));
        const activeClass = isActive ? 'bg-muted' : 'hover:bg-muted/50';
        // Badge hanya muncul jika unread > 0 DAN kita tidak sedang membuka chat tersebut
        const showBadge = t.unread > 0 && !isActive; 
        
        const unreadBadge = showBadge
          ? `<span class="inline-flex items-center justify-center rounded-full bg-primary text-primary-foreground text-xs px-2 py-0.5 font-medium">${t.unread}</span>`
          : '';
        
        return `
          <button type="button"
                  class="w-full flex items-center gap-3 p-3 rounded-lg ${activeClass} cursor-pointer transition-colors chat-thread-item"
                  data-chat-id="${t.id}"
                  data-name="${t.name}"
                  data-initials="${t.initials}"
                  data-fetch-url="${t.fetch_url}">
            <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary text-sm font-semibold">
              ${t.initials}
            </div>
            <div class="flex-1 min-w-0 text-left">
              <div class="flex items-center justify-between mb-1">
                <p class="font-medium text-sm text-foreground truncate">${t.name}</p>
                <span class="text-xs text-muted-foreground">${t.last_time}</span>
              </div>
              <p class="text-xs text-muted-foreground truncate">
                ${t.last_message}
              </p>
            </div>
            ${unreadBadge}
          </button>
        `;
      }).join('');
      
      chatListContainer.innerHTML = html;
    }

    function fetchChatList() {
      fetch(API_THREAD_LIST_URL, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            renderChatList(data.threads);
            // Update total unread di header sidebar
            const total = data.threads.reduce((acc, t) => acc + t.unread, 0);
            if(unreadLabel) unreadLabel.textContent = total;
          }
        })
        .catch(err => console.error("List polling error:", err));
    }

    // ---------------- LOGIC 2: DETAIL CHAT (MESSAGES) ----------------
    
    // Fungsi Fetch Messages (Polling & Initial Load)
    function fetchMessages(url, isInitialLoad = false) {
      if (!url) return;

      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(res => res.json())
        .then(res => {
          if (!res.success) {
            if (isInitialLoad) {
                messagesContainer.innerHTML = '';
                appendMessageBubble({sender:'buyer', text: res.message || 'Error', time:''});
            }
            return;
          }

          // Jika ini load pertama (klik dari list), bersihkan container
          if (isInitialLoad) {
            messagesContainer.innerHTML = '';
            renderedMessageIds.clear(); 
          }

          // Loop pesan dari server
          const messages = res.messages || [];
          let hasNewMessage = false;

          messages.forEach(msg => {
            // Cek apakah ID sudah ada? Jika belum, append.
            if (!renderedMessageIds.has(msg.id)) {
              appendMessageBubble(msg, true); // true = scroll to bottom
              hasNewMessage = true;
            }
          });
          
          // Jika ada pesan baru masuk saat polling, refresh list juga biar 'Last Message' update
          if (hasNewMessage && !isInitialLoad) {
             fetchChatList(); 
          }
        })
        .catch(err => console.error("Detail polling error:", err));
    }

    // Start/Stop Detail Polling
    function startDetailPolling(url) {
      // Hentikan polling lama jika ada
      if (detailPollingInterval) clearInterval(detailPollingInterval);
      
      // Load pertama (langsung)
      fetchMessages(url, true);

      // Mulai interval (setiap 3 detik)
      detailPollingInterval = setInterval(() => {
        fetchMessages(url, false); // false = bukan load awal (silent update)
      }, 3000);
    }

    function stopDetailPolling() {
      if (detailPollingInterval) clearInterval(detailPollingInterval);
      detailPollingInterval = null;
    }

    // ---------------- EVENT HANDLERS ----------------

    // 1. Klik Item Chat di List
    chatListContainer.addEventListener('click', function(e) {
      const btn = e.target.closest('.chat-thread-item');
      if (!btn) return;

      const chatId = btn.dataset.chatId;
      const fetchUrl = btn.dataset.fetchUrl;

      activeChatId = chatId;
      activeChatApiUrl = fetchUrl;
      
      // Update Header Detail
      detailName.textContent = btn.dataset.name;
      detailAvatar.textContent = btn.dataset.initials;

      // Ganti View
      listView.classList.add('hidden');
      detailView.classList.remove('hidden');

      // MULAI POLLING DETAIL
      startDetailPolling(fetchUrl);
    });

    // 2. Klik Tombol Back
    if (backBtn) {
      backBtn.addEventListener('click', function () {
        activeChatId = null;
        activeChatApiUrl = null;
        
        // STOP POLLING DETAIL
        stopDetailPolling();

        detailView.classList.add('hidden');
        listView.classList.remove('hidden');
        
        // Refresh list
        fetchChatList();
      });
    }

    // 3. Kirim Pesan
    if (chatForm && chatInput) {
      chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const value = chatInput.value.trim();
        if (!value || !activeChatApiUrl) return;

        fetch(activeChatApiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ message: value })
        })
        .then(res => res.json())
        .then(res => {
          if (res.success) {
            // Manual append biar instan (UX)
            // Kita pakai ID dummy sementara agar tidak bentrok saat polling update
            const nowTime = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            appendMessageBubble({
                id: 'local-' + Date.now(), 
                sender: 'seller', 
                text: value, 
                time: nowTime
            });
            
            chatInput.value = '';
            fetchChatList(); // Refresh sidebar
          }
        });
      });
    }

    // 4. Global Polling Control (Visibility)
    function startGlobalPolling() {
      fetchChatList();
      listPollingInterval = setInterval(fetchChatList, 5000); // List polling 5 detik
      
      // Jika sedang buka chat, resume detail polling
      if (activeChatId && activeChatApiUrl) {
          startDetailPolling(activeChatApiUrl);
      }
    }

    function stopGlobalPolling() {
      if (listPollingInterval) clearInterval(listPollingInterval);
      stopDetailPolling();
    }

    // Start List Polling saat load
    startGlobalPolling();

    // Hemat resource jika tab tidak aktif
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopGlobalPolling();
      else startGlobalPolling();
    });

  });
</script>
{% endblock %}