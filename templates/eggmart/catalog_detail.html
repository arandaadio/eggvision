{% extends "eggmart/base.html" %}

{% block content %}
<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{ midtrans_client_key }}"></script>

<div x-data="{ 
    chatOpen: false, 
    cart: {}, 
    isLoading: false,
    
    // --- New Variables for Header ---
    profileModalOpen: false,
    profileTab: 'info',
    profileName: '{{ current_user.name }}',
    profileEmail: '{{ current_user.email }}',
    profileLocation: '{{ current_user.farm_location or '' }}',
    locationMode: 'manual',
    isDetectingLocation: false,
    
    shopDropdownOpen: false,
    allShops: [], // To store list of other shops

    formatRupiah(num) {
        return 'Rp ' + parseInt(num).toLocaleString('id-ID');
    },

    init() {
        // Fetch all shops for the dropdown
        this.fetchShops();
        
        // Auto-detect location if empty
        if (!this.profileLocation || this.profileLocation === 'None') {
            this.detectLocation(true);
        }
    },

    async fetchShops() {
        try {
            // Reusing the catalog API to get list of sellers
            const res = await fetch(`{{ url_for('eggmart_controller.api_filter_catalog') }}`);
            const data = await res.json();
            if(data.success) {
                this.allShops = data.sellers;
            }
        } catch(err) {
            console.error('Failed to load shops', err);
        }
    },
    
    addToCart(id, price, maxStock) {
        if (!this.cart[id]) this.cart[id] = { qty: 0, price: price };
        if (this.cart[id].qty < maxStock) {
            this.cart[id].qty++;
        } else {
            alert('Stok maksimum tercapai.');
        }
    },
    
    removeFromCart(id) {
        if (this.cart[id] && this.cart[id].qty > 0) {
            this.cart[id].qty--;
            if (this.cart[id].qty === 0) delete this.cart[id];
        }
    },
    
    get total() {
        let sum = 0;
        for (let id in this.cart) {
            sum += this.cart[id].qty * this.cart[id].price;
        }
        return sum;
    },

    get totalQty() {
        let sum = 0;
        for (let id in this.cart) {
            sum += this.cart[id].qty;
        }
        return sum;
    },

    async checkout() {
        const items = Object.entries(this.cart).filter(([_, val]) => val.qty > 0);
        if (items.length === 0) {
            alert('Pilih minimal satu produk.');
            return;
        }
        
        // Take the first item (current logic handles 1 transaction per checkout)
        const [listingId, item] = items[0];
        this.isLoading = true;

        try {
            const response = await fetch(`{{ url_for('eggmart_controller.create_transaction') }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ listing_id: listingId, quantity: item.qty })
            });

            const result = await response.json();

            if (result.success && result.snap_token) {
                window.snap.pay(result.snap_token, {
                    onSuccess: function(result){ window.location.href = `{{ url_for('eggmart_controller.eggmartHistory') }}?new_order_code=${result.order_id}`; },
                    onPending: function(result){ window.location.href = `{{ url_for('eggmart_controller.eggmartHistory') }}?new_order_code=${result.order_id}`; },
                    onError: function(result){ alert('Pembayaran gagal!'); console.error(result); },
                    onClose: function(){ alert('Anda menutup popup tanpa menyelesaikan pembayaran'); }
                });
            } else {
                alert(result.message || 'Gagal membuat transaksi.');
            }
        } catch (err) {
            console.error('Checkout Error:', err);
            alert('Terjadi kesalahan koneksi.');
        } finally {
            this.isLoading = false;
        }
    },

    // --- Profile Logic ---
    detectLocation(isAuto = false) {
        if (!navigator.geolocation) { alert('Browser Anda tidak mendukung Geolocation.'); return; }
        this.isDetectingLocation = true;
        if (!isAuto) this.locationMode = 'gps';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
                    .then(response => response.json())
                    .then(data => {
                        this.profileLocation = data.display_name;
                        this.isDetectingLocation = false;
                        if (isAuto) this.saveProfile(true);
                    })
                    .catch(err => { this.isDetectingLocation = false; });
            },
            (error) => { this.isDetectingLocation = false; }
        );
    },
}">

    <header class="sticky top-0 z-40 w-full border-b border-gray-200 dark:border-dark-border bg-paper/90 dark:bg-dark-surface/90 backdrop-blur-md transition-colors duration-300">
      <div class="container mx-auto px-4 h-20 flex items-center justify-between">
          
          <div class="flex-shrink-0">
              <a href="{{ url_for('eggmart_controller.eggmart') }}" class="flex items-center gap-3 sm:gap-4 group">
                  <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="h-8 sm:h-10 w-auto">
                  <div class="h-5 sm:h-6 w-px bg-gray-300 dark:bg-gray-700 hidden xs:block"></div>
                  <span class="font-canela font-normal text-xl sm:text-2xl text-ink dark:text-white tracking-wide group-hover:text-primary transition-colors hidden xs:block">
                      EggMart
                  </span>
              </a>
          </div>

          <div class="hidden lg:flex items-center gap-4">
              <div class="flex items-center gap-3 px-5 py-2 rounded-full bg-white dark:bg-white/5 border border-gray-200 dark:border-dark-border shadow-sm">
                  <div class="w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-800 overflow-hidden border border-gray-200 dark:border-gray-700">
                      <img src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ current_user.name }}" alt="User" class="w-full h-full">
                  </div>
                  <div class="flex flex-col items-start">
                      <span class="text-[10px] font-bold uppercase text-gray-400 leading-none mb-0.5">Dikirim ke</span>
                      <div class="flex items-center gap-1 text-xs font-bold text-ink dark:text-white">
                          <span class="truncate max-w-[200px]" x-text="profileLocation ? profileLocation.split(',')[0] : 'Atur Lokasi'"></span>
                      </div>
                  </div>
              </div>

              <div class="relative" @click.outside="shopDropdownOpen = false">
                  <button 
                      @click="shopDropdownOpen = !shopDropdownOpen"
                      class="flex items-center gap-3 px-5 py-2 rounded-full bg-white dark:bg-white/5 border border-gray-200 dark:border-dark-border hover:border-primary/50 transition-all shadow-sm group">
                      <div class="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                          <i data-lucide="store" class="w-3.5 h-3.5"></i>
                      </div>
                      <div class="flex flex-col items-start">
                          <span class="text-[10px] font-bold uppercase text-gray-400 leading-none mb-0.5">Toko Terpilih</span>
                          <div class="flex items-center gap-1 text-xs font-bold text-ink dark:text-white group-hover:text-primary transition-colors">
                              <span class="truncate max-w-[150px]">{{ seller.name }}</span>
                              <i data-lucide="chevron-down" class="w-3 h-3 transition-transform duration-300" :class="shopDropdownOpen ? 'rotate-180' : ''"></i>
                          </div>
                      </div>
                  </button>

                  <div x-show="shopDropdownOpen" 
                      x-transition:enter="transition ease-out duration-200"
                      x-transition:enter-start="opacity-0 translate-y-2"
                      x-transition:enter-end="opacity-100 translate-y-0"
                      x-cloak
                      class="absolute top-full mt-2 left-0 w-64 bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-dark-border rounded-xl shadow-xl overflow-hidden z-50 py-2">
                      
                      <div class="px-4 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Ganti Toko</div>
                      
                      <template x-for="shop in allShops" :key="shop.id">
                          <a :href="shop.detail_url" 
                            class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors border-l-2 border-transparent hover:border-primary">
                              <div class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-white/10 flex items-center justify-center font-canela text-primary font-bold text-xs" x-text="shop.code"></div>
                              <div class="flex-1 min-w-0">
                                  <p class="text-sm font-bold text-ink dark:text-white truncate" x-text="shop.name"></p>
                                  <p class="text-xs text-gray-500 truncate" x-text="shop.location"></p>
                              </div>
                          </a>
                      </template>
                      
                      <div x-show="allShops.length === 0" class="px-4 py-3 text-sm text-gray-500 text-center">
                          Memuat daftar toko...
                      </div>
                  </div>
              </div>

          </div>
          
          <div class="flex items-center gap-3">
              <button 
                  onclick="toggleDarkMode()" 
                  class="relative inline-flex items-center w-12 h-6 sm:w-14 sm:h-7 rounded-full transition-colors duration-300 ease-in-out 
                      bg-gray-300 dark:bg-gray-600 hover:ring-2 hover:ring-premium-gold focus:outline-none"
                  aria-label="Toggle dark mode"
              >
                  <span 
                      class="absolute left-0.5 top-0.5 w-5 h-5 sm:left-1 sm:top-1 sm:w-5 sm:h-5 rounded-full bg-white dark:bg-primary-black transform transition-transform duration-300 ease-in-out 
                          dark:translate-x-6 sm:dark:translate-x-7"
                  ></span>
                  
                  <svg xmlns="http://www.w3.org/2000/svg" 
                      class="absolute left-1.5 w-3 h-3 sm:w-4 sm:h-4 text-gray-700 dark:hidden" 
                      fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M12 3v1m0 16v1m8.66-9H21M3 12H2m15.36-6.36l.7.7M6.34 17.66l.7.7M17.66 17.66l.7-.7M6.34 6.34l.7-.7M12 8a4 4 0 100 8 4 4 0 000-8z" />
                  </svg>
                  
                  <svg xmlns="http://www.w3.org/2000/svg" 
                      class="absolute right-1.5 w-3 h-3 sm:w-4 sm:h-4 hidden dark:block text-yellow-400" 
                      fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 2a8 8 0 107.446 5.032A6 6 0 0110 2z"/>
                  </svg>
              </button>
          </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8 space-y-8">

        <div class="flex flex-col lg:flex-row gap-6 h-auto lg:h-[400px] transition-all duration-500">
            
            <div class="relative bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-3xl overflow-hidden shadow-sm flex flex-col transition-all duration-500"
                 :class="chatOpen ? 'lg:w-1/2' : 'w-full'">
                
                <div class="h-32 bg-gradient-to-r from-gray-100 to-gray-200 dark:from-[#222] dark:to-[#1a1a1a] relative">
                    <div class="absolute top-6 right-6 flex gap-2">
                        <div class="px-3 py-1.5 bg-white/90 dark:bg-black/60 backdrop-blur rounded-lg text-sm font-bold flex items-center gap-1 shadow-sm">
                            <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400"></i> {{ seller.rating }}
                        </div>
                    </div>
                </div>

                <div class="px-8 pb-8 -mt-12 flex flex-col flex-1 relative z-10">
                    <div class="flex justify-between items-end mb-6">
                        <div class="w-24 h-24 rounded-3xl bg-white dark:bg-[#222] shadow-xl flex items-center justify-center border-4 border-white dark:border-dark-surface text-4xl font-canela font-normal text-primary relative z-20">
                            {{ seller.code }}
                        </div>
                        
                        <button @click="chatOpen = !chatOpen" 
                                class="px-6 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 transition-all border"
                                :class="chatOpen ? 'bg-primary text-black border-primary' : 'bg-white dark:bg-white/5 text-ink dark:text-white border-gray-200 dark:border-dark-border hover:border-primary'">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            <span x-text="chatOpen ? 'Tutup Chat' : 'Chat Penjual'"></span>
                        </button>
                    </div>

                    <div>
                        <h1 class="font-canela font-normal text-4xl text-ink dark:text-white mb-2">{{ seller.name }}</h1>
                        <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400 mb-6">
                            <i data-lucide="map-pin" class="w-4 h-4"></i>
                            <span>{{ seller.location }}</span>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 border-t border-gray-100 dark:border-dark-border pt-6">
                            <div>
                                <p class="text-xs font-bold uppercase text-gray-400 tracking-wider mb-1">Total Ulasan</p>
                                <p class="text-lg font-bold text-ink dark:text-white">{{ seller.review_count }}</p>
                            </div>
                            <div>
                                <p class="text-xs font-bold uppercase text-gray-400 tracking-wider mb-1">Bergabung</p>
                                <p class="text-lg font-bold text-ink dark:text-white">2024</p>
                            </div>
                            <div>
                                <p class="text-xs font-bold uppercase text-gray-400 tracking-wider mb-1">Status</p>
                                <p class="text-lg font-bold text-green-500">Terverifikasi</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="chatOpen" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-x-10"
                 x-transition:enter-end="opacity-100 translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-x-0"
                 x-transition:leave-end="opacity-0 translate-x-10"
                 class="lg:w-1/2 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-3xl shadow-sm flex flex-col overflow-hidden h-[500px] lg:h-auto">
                
                <div class="p-4 border-b border-gray-100 dark:border-dark-border flex justify-between items-center bg-gray-50 dark:bg-white/5">
                    <span class="font-bold text-sm">Live Chat</span>
                    <button @click="chatOpen = false"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>

                <div id="chatMessages" class="flex-1 p-4 overflow-y-auto bg-gray-50/50 dark:bg-black/20 space-y-3">
                    <div class="text-center text-xs text-gray-400 mt-4">Mulai percakapan dengan penjual...</div>
                </div>

                <div class="p-4 border-t border-gray-200 dark:border-dark-border">
                    <form id="chatForm" class="flex gap-2">
                        <input id="chatInput" type="text" placeholder="Tulis pesan..." class="flex-1 bg-transparent border border-gray-200 dark:border-dark-border rounded-xl px-4 py-2 text-sm focus:border-primary outline-none">
                        <button type="submit" class="p-2 bg-black dark:bg-white text-white dark:text-black rounded-xl hover:bg-primary transition-colors">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 items-start">
            
            <div class="flex-1 w-full bg-paper dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-2xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200 dark:border-dark-border">
                    <h2 class="font-canela font-normal text-3xl text-ink dark:text-white">Katalog Produk</h2>
                </div>

                <div class="space-y-4">
                    {% for product in seller.products %}
                    {% set is_out_of_stock = product.stock <= 0 or product.id == 0 %}
                    
                    <div class="group bg-white dark:bg-black/20 border border-gray-200 dark:border-dark-border p-4 sm:p-6 rounded-xl hover:border-primary/50 transition-all duration-300 flex flex-col sm:flex-row sm:items-center gap-6 {{ 'opacity-60 grayscale' if is_out_of_stock else '' }}">
                        
                        <div class="w-full sm:w-32 h-32 bg-gray-100 dark:bg-black rounded-xl flex items-center justify-center flex-shrink-0 relative overflow-hidden">
                            <div class="text-center">
                                <span class="block font-canela text-4xl text-primary mb-1">{{ product.grade }}</span>
                                <span class="text-[10px] uppercase tracking-widest text-gray-400">Grade</span>
                            </div>
                            {% if is_out_of_stock %}
                                <div class="absolute inset-0 bg-black/50 flex items-center justify-center">
                                    <span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded transform -rotate-12">
                                        {{ 'BELUM ADA' if product.id == 0 else 'HABIS' }}
                                    </span>
                                </div>
                            {% endif %}
                        </div>

                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg">Telur Ayam Grade {{ product.grade }}</h3>
                                <span class="px-2 py-1 {{ 'bg-red-100 text-red-600' if is_out_of_stock else 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' }} text-xs font-bold rounded-md">
                                    {{ 'Stok Habis' if is_out_of_stock else 'Stok: ' ~ product.stock }}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">{{ product.description }}</p>
                            
                            <div class="flex items-center justify-between">
                              <div class="text-xl font-mono font-bold text-ink dark:text-white">
                                  {% if product.price > 0 %}
                                      Rp {{ "{:,.0f}".format(product.price).replace(',', '.') }} <span class="text-xs text-gray-400 font-sans font-normal">/ butir</span>
                                  {% else %}
                                      <span class="text-sm text-gray-400 font-sans font-normal">-</span>
                                  {% endif %}
                              </div>
                          
                              {% if not is_out_of_stock %}
                                  <div class="flex items-center gap-3 bg-gray-50 dark:bg-white/5 rounded-lg p-1 border border-gray-200 dark:border-dark-border">
                                      <button @click="removeFromCart('{{ product.id }}')" class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-white dark:hover:bg-white/10 transition-colors" :class="!cart['{{ product.id }}'] || cart['{{ product.id }}'].qty === 0 ? 'text-gray-300' : 'text-ink dark:text-white'">
                                          <i data-lucide="minus" class="w-4 h-4"></i>
                                      </button>
                                      
                                      <span class="w-8 text-center font-mono text-sm font-bold" x-text="cart['{{ product.id }}'] ? cart['{{ product.id }}'].qty : 0">0</span>
                                      
                                      <button @click="addToCart('{{ product.id }}', {{ product.price }}, {{ product.stock }})" class="w-8 h-8 flex items-center justify-center rounded-md bg-white dark:bg-white/10 shadow-sm hover:text-primary transition-colors">
                                          <i data-lucide="plus" class="w-4 h-4"></i>
                                      </button>
                                  </div>
                              {% else %}
                                  <button disabled class="px-4 py-2 bg-gray-200 dark:bg-white/10 text-gray-400 text-xs font-bold rounded-lg cursor-not-allowed">
                                      {{ 'Belum Tersedia' if product.id == 0 else 'Stok Habis' }}
                                  </button>
                              {% endif %}
                          </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="w-full lg:w-96 flex-shrink-0">
                <div class="sticky top-28 bg-paper dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-2xl p-6 shadow-lg">
                    <h3 class="font-canela font-normal text-2xl mb-6">Ringkasan Pesanan</h3>
                    
                    <div class="space-y-4 mb-6 min-h-[100px]">
                        <template x-for="(item, id) in cart" :key="id">
                            <div x-show="item.qty > 0" class="flex justify-between items-center text-sm">
                                <span class="text-gray-600 dark:text-gray-300">
                                    <span class="font-bold text-ink dark:text-white" x-text="item.qty + 'x'"></span> 
                                    Telur (Item ID: <span x-text="id"></span>)
                                </span>
                                <span class="font-mono" x-text="formatRupiah(item.qty * item.price)"></span>
                            </div>
                        </template>
                        <div x-show="totalQty === 0" class="text-center text-gray-400 text-sm py-4 italic">
                            Belum ada produk dipilih
                        </div>
                    </div>

                    <div class="h-px w-full bg-gray-200 dark:bg-dark-border mb-4"></div>

                    <div class="flex justify-between items-center mb-6">
                        <span class="font-bold text-lg">Total Bayar</span>
                        <span class="font-canela text-2xl text-primary" x-text="formatRupiah(total)">Rp 0</span>
                    </div>

                    <div class="mb-6 p-3 bg-yellow-50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/30 rounded-xl flex gap-3 items-start">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"></i>
                        <div class="text-xs text-yellow-800 dark:text-yellow-500">
                            <p class="font-bold mb-1">Cek Lokasi Anda</p>
                            Pastikan lokasi pengiriman sudah benar di <a href="{{ url_for('eggmart_controller.eggmart') }}" class="underline hover:text-black dark:hover:text-white">Halaman Utama</a>.
                        </div>
                    </div>

                    <button @click="checkout()" 
                            :disabled="totalQty === 0 || isLoading"
                            class="w-full py-4 bg-black dark:bg-white text-white dark:text-black font-bold text-sm uppercase tracking-widest rounded-xl hover:bg-primary hover:text-black dark:hover:bg-primary disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2">
                        <span x-show="!isLoading">Bayar Sekarang</span>
                        <span x-show="isLoading">Memproses...</span>
                        <i x-show="!isLoading" data-lucide="credit-card" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

        </div>

        <div class="mt-16 border-t border-gray-200 dark:border-dark-border pt-16">
            <div class="flex items-center justify-between mb-10">
                <div>
                    <h2 class="font-canela font-normal text-3xl mb-2">Ulasan Pembeli</h2>
                    <p class="text-gray-500">Apa kata mereka tentang toko ini</p>
                </div>
                <div class="flex items-center gap-2 bg-yellow-100 dark:bg-yellow-900/20 px-4 py-2 rounded-full text-yellow-700 dark:text-yellow-500 font-bold">
                    <i data-lucide="star" class="w-5 h-5 fill-current"></i> {{ seller.rating }} / 5.0
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for review in reviews %}
                <div class="p-6 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-2xl">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-sm">
                                {{ (review.buyer_name.split(' ')[0][0] ~ review.buyer_name.split(' ')[1][0]) if review.buyer_name else 'AN' }}
                            </div>
                            <div>
                                <h4 class="font-bold text-sm text-ink dark:text-white">{{ review.buyer_name or 'Anonim' }}</h4>
                                <div class="flex gap-0.5">
                                    {% for s in range(review.rating) %}
                                    <i data-lucide="star" class="w-3 h-3 fill-primary text-primary"></i>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <span class="text-xs text-gray-400">{{ review.created_at.strftime('%d %b %Y') if review.created_at else '' }}</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">"{{ review.review }}"</p>
                </div>
                {% else %}
                <div class="col-span-2 text-center py-12 text-gray-500">Belum ada ulasan untuk toko ini.</div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sellerId = {{ seller.id }};
        const chatUrl = "{{ url_for('eggmart_controller.get_chat_for_seller', seller_id=seller.id) }}";
        const postUrl = "{{ url_for('eggmart_controller.send_chat_to_seller', seller_id=seller.id) }}";

        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const messagesBox = document.getElementById('chatMessages');

        fetch(chatUrl).then(res=>res.json()).then(data => {
            if(data.success && data.messages) {
                messagesBox.innerHTML = '';
                data.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-xl text-xs max-w-[80%] mb-2 ${msg.sender === 'self' ? 'bg-primary text-black ml-auto rounded-br-none' : 'bg-gray-100 dark:bg-white/10 dark:text-white mr-auto rounded-bl-none'}`;
                    div.innerText = msg.text;
                    messagesBox.appendChild(div);
                });
            }
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = chatInput.value;
            if(!text) return;
            
            const div = document.createElement('div');
            div.className = `p-3 rounded-xl text-xs max-w-[80%] mb-2 bg-primary text-black ml-auto rounded-br-none`;
            div.innerText = text;
            messagesBox.appendChild(div);
            chatInput.value = '';
            messagesBox.scrollTop = messagesBox.scrollHeight;

            fetch(postUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: text})
            });
        });
    });
</script>
{% endblock %}