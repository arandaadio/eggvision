<div id="chat-widget-container" class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-[100] font-sans">

    <button id="chat-toggle" 
            class="group relative 
                w-12 h-14 sm:w-14 sm:h-16  bg-premium-gold hover:bg-yellow-400 text-primary-black 
                rounded-[50%_50%_50%_50%_/_60%_60%_40%_40%] 
                shadow-xl flex items-center justify-center 
                transition-all duration-300 hover:scale-105 hover:rotate-6 
                focus:outline-none focus:ring-4 focus:ring-yellow-500/50 z-50">
        
        <svg class="w-5 h-5 sm:w-6 sm:h-6 transform transition-transform duration-300 group-hover:scale-0 absolute" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        
        <svg class="w-5 h-5 sm:w-6 sm:h-6 transform scale-0 transition-transform duration-300 group-hover:scale-100 absolute" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        
        <span class="absolute top-0 right-1 flex h-2.5 w-2.5"> 
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500"></span>
        </span>
    </button>

    <div id="chat-box" 
         class="fixed bottom-0 right-0 left-0 sm:left-auto sm:inset-auto sm:absolute sm:bottom-24 sm:right-0 
                w-full sm:w-96 
                h-[70vh] sm:h-[28rem] 
                bg-white/95 dark:bg-dark-gray/95 backdrop-blur-md 
                border-t border-x sm:border border-gray-200 dark:border-gray-700 
                rounded-t-2xl sm:rounded-2xl shadow-2xl flex flex-col 
                transition-all duration-300 ease-in-out 
                origin-bottom-right transform translate-y-[120%] sm:translate-y-10 sm:scale-0 sm:opacity-0 z-40">
        
        <div class="bg-gradient-to-r from-premium-gold to-yellow-500 text-primary-black px-6 py-3 sm:py-4 rounded-t-2xl flex justify-between items-center shadow-sm shrink-0 cursor-pointer" id="chat-header-mobile">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-green-600 animate-pulse"></div>
                <div>
                    <h3 class="font-bold text-lg leading-tight">EggMin</h3>
                    <p class="text-xs font-medium opacity-80">Online & Siap Membantu</p>
                </div>
            </div>
            <button id="chat-minimize-mobile" class="sm:hidden text-primary-black hover:bg-black/10 rounded-full p-1 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
        </div>

        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gray-50 dark:bg-[#121212]">
            <div class="flex justify-start animate-fade-in-up" data-msg-id="welcome">
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%] shadow-sm">
                    <p class="text-sm text-gray-800 dark:text-gray-200 leading-relaxed">
                        Halo! ðŸ‘‹ Selamat datang di EggVision. <br>Ada yang bisa kami bantu mengenai teknologi grading telur kami?
                    </p>
                    <span class="text-[10px] text-gray-400 block mt-1 text-right">EggMin â€¢ Baru saja</span>
                </div>
            </div>
        </div>

        <div id="guest-info" class="px-6 py-4 bg-gray-50 dark:bg-dark-gray border-t border-gray-100 dark:border-gray-700 {% if current_user.is_authenticated %}hidden{% endif %}">
            <div class="space-y-3">
                <input type="text" id="guest-name" placeholder="Nama Lengkap" 
                       class="w-full px-4 py-2 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-premium-gold outline-none shadow-sm placeholder-gray-500">
                <input type="email" id="guest-email" placeholder="Alamat Email" 
                       class="w-full px-4 py-2 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-premium-gold outline-none shadow-sm placeholder-gray-500">
            </div>
        </div>

        <div class="p-3 sm:p-4 bg-white dark:bg-dark-gray border-t border-gray-200 dark:border-gray-700 sm:rounded-b-2xl shrink-0">
            <div class="flex items-center gap-2">
                <input type="text" id="chat-input" placeholder="Tulis pesan..." 
                       class="flex-1 px-4 py-2.5 sm:py-3 rounded-full bg-gray-100 dark:bg-gray-800 border-0 text-gray-900 dark:text-white placeholder-gray-500 focus:ring-2 focus:ring-premium-gold transition-all text-sm">
                
                <button id="send-message" 
                        class="w-10 h-10 sm:w-11 sm:h-11 bg-premium-gold text-primary-black rounded-full flex items-center justify-center shadow-md hover:bg-yellow-400 transition-all duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Scrollbar */
    #chat-messages { 
        scrollbar-width: thin; 
        scrollbar-color: #cbd5e0 transparent; 
        
        /* THIS IS THE FIX: Prevents scroll from passing to the body */
        overscroll-behavior-y: contain; 
    }
    
    .dark #chat-messages { scrollbar-color: #4b5563 transparent; }
    #chat-messages::-webkit-scrollbar { width: 4px; }
    #chat-messages::-webkit-scrollbar-track { background: transparent; }
    #chat-messages::-webkit-scrollbar-thumb { background-color: #cbd5e0; border-radius: 10px; }
    .dark #chat-messages::-webkit-scrollbar-thumb { background-color: #4b5563; }

    /* Animations */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }

    /* iOS Safe Area for mobile inputs */
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const chatBox = document.getElementById('chat-box');
        const chatToggle = document.getElementById('chat-toggle');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-message');
        const chatMessages = document.getElementById('chat-messages');
        const guestInfo = document.getElementById('guest-info');
        const guestName = document.getElementById('guest-name');
        const guestEmail = document.getElementById('guest-email');
        const chatMinimizeMobile = document.getElementById('chat-minimize-mobile');
        const chatHeaderMobile = document.getElementById('chat-header-mobile');
    
        let isChatOpen = false;
        let pollingInterval = null;
        
        let existingMessageIds = new Set(); 
        existingMessageIds.add('welcome'); 
    
        // 1. LOAD GUEST INFO
        const savedName = localStorage.getItem('eggvision_guest_name');
        const savedEmail = localStorage.getItem('eggvision_guest_email');
        
        {% if not current_user.is_authenticated %}
            if(savedName && savedEmail) {
                guestName.value = savedName;
                guestEmail.value = savedEmail;
                guestInfo.classList.add('hidden'); 
            }
        {% else %}
            guestInfo.classList.add('hidden');
        {% endif %}
    
        // 2. TOGGLE CHAT
        function toggleChat() {
            isChatOpen = !isChatOpen;
            const isMobile = window.innerWidth < 640;
            
            if (isChatOpen) {
                chatBox.classList.remove('translate-y-[120%]', 'sm:translate-y-10', 'sm:scale-0', 'sm:opacity-0');
                if (isMobile) {
                    chatToggle.classList.add('scale-0', 'opacity-0', 'pointer-events-none');
                    document.body.style.overflow = 'hidden';
                }
                setTimeout(() => chatInput.focus(), 300);
                
                loadMessages(true); 
                if (!pollingInterval) {
                    pollingInterval = setInterval(() => loadMessages(false), 3000);
                }
            } else {
                chatBox.classList.add('translate-y-[120%]', 'sm:translate-y-10', 'sm:scale-0', 'sm:opacity-0');
                chatToggle.classList.remove('scale-0', 'opacity-0', 'pointer-events-none');
                document.body.style.overflow = '';
                
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            }
        }
    
        chatToggle.addEventListener('click', toggleChat);
        chatMinimizeMobile.addEventListener('click', (e) => { e.stopPropagation(); toggleChat(); });
        chatHeaderMobile.addEventListener('click', function() { if(window.innerWidth < 640) toggleChat(); });
    
        // 3. HTML HELPER
        function createMessageHTML(message, messageType, time, id) {
            const isMe = (messageType === 'user_to_admin' || messageType === 'guest_to_admin');
            const alignClass = isMe ? 'justify-end' : 'justify-start';
            const bubbleClass = isMe 
                ? 'bg-premium-gold text-primary-black rounded-tr-none' 
                : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 dark:text-gray-200 rounded-tl-none';
            const senderLabel = isMe ? 'Anda' : 'Admin';
            
            // Time formatting logic...
            let displayTime = time || 'Baru saja';
            try {
                const dateObj = new Date(displayTime);
                if (!isNaN(dateObj)) displayTime = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch(e) {}
    
            const timeColorClass = isMe ? 'text-primary-black text-left' : 'text-primary-black dark:text-pure-white text-right';
    
            return `
                <div class="flex ${alignClass} animate-fade-in-up" data-msg-id="${id}">
                    <div class="${bubbleClass} rounded-2xl px-4 py-2.5 max-w-[85%] shadow-sm text-sm relative group">
                        <p class="leading-relaxed">${message}</p>
                        <span class="text-[10px] opacity-60 block mt-1 ${timeColorClass}">
                            ${senderLabel} â€¢ ${displayTime}
                        </span>
                    </div>
                </div>
            `;
        }
    
        // 4. LOAD MESSAGES
        function loadMessages(shouldScroll) {
            let url = '{{ url_for("comprof_controller.comprof_get_chat_history") }}';
            
            {% if not current_user.is_authenticated %}
                const email = guestEmail.value.trim();
                if(!email) return; 
                url += `?guest_email=${encodeURIComponent(email)}`;
            {% endif %}
    
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if(data.success && data.messages) {
                        data.messages.forEach((msg) => {
                            // Gunakan Session ID + ID Message (atau timestamp) untuk unik key
                            const msgId = "msg_" + (msg.id || msg.created_at); 
    
                            if (!existingMessageIds.has(msgId)) {
                                const html = createMessageHTML(msg.message, msg.message_type, msg.created_at, msgId);
                                chatMessages.insertAdjacentHTML('beforeend', html);
                                existingMessageIds.add(msgId);
                            }
                        });
    
                        if (shouldScroll) scrollToBottom();
                    }
                })
                .catch(err => console.error("Polling error:", err));
        }
    
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    
        // 5. SEND MESSAGE
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
    
            {% if not current_user.is_authenticated %}
                if (!guestName.value.trim() || !guestEmail.value.trim()) {
                    alert("Mohon isi Nama dan Email Anda untuk memulai chat.");
                    return;
                }
                localStorage.setItem('eggvision_guest_name', guestName.value.trim());
                localStorage.setItem('eggvision_guest_email', guestEmail.value.trim());
                guestInfo.classList.add('hidden');
            {% endif %}
    
            // Optimistic UI
            const tempId = 'temp_' + Date.now();
            const tempHtml = createMessageHTML(message, 'user_to_admin', 'Mengirim...', tempId);
            chatMessages.insertAdjacentHTML('beforeend', tempHtml);
            scrollToBottom(); 
            chatInput.value = ''; 
    
            fetch('{{ url_for("comprof_controller.comprof_send_chat") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    {% if current_user.is_authenticated %}
                    user_id: '{{ current_user.id }}',
                    {% else %}
                    guest_name: guestName.value.trim(),
                    guest_email: guestEmail.value.trim(),
                    {% endif %}
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const tempElement = document.querySelector(`[data-msg-id="${tempId}"]`);
                    if (tempElement) tempElement.remove();
                    loadMessages(true);
                } else {
                    alert("Gagal mengirim: " + data.error);
                    const tempElement = document.querySelector(`[data-msg-id="${tempId}"]`);
                    if (tempElement) tempElement.remove();
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    });
</script>