{% extends "eggmonitor/base.html" %}
{% block title %}Laporan Produksi Â· EggMonitor{% endblock %}

{% block page_title %}Laporan Produksi{% endblock %}
{% block page_subtitle %}Rekapitulasi data grading dan analisis kualitas.{% endblock %}

{% block head %}
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
{% endblock %}

{% block content %}
<div x-data="laporanData">

    <!-- Debug info - remove this in production
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4" x-show="debug.show">
        <div class="flex justify-between items-center">
            <h4 class="font-bold text-yellow-800">Debug Info</h4>
            <button @click="debug.show = false" class="text-yellow-600 hover:text-yellow-800">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <div class="text-sm text-yellow-700 mt-2">
            <p>Total Records: <span x-text="allRows.length"></span></p>
            <p>Filtered Records: <span x-text="filteredRows.length"></span></p>
            <p>Chart Data: <span x-text="JSON.stringify(debug.chartData)"></span></p>
            <p>Chart Initialized: <span x-text="debug.chartInitialized"></span></p>
            <p>Date Range: <span x-text="dateRange"></span></p>
        </div>
    </div>  -->

    <div class="bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-2xl p-5 mb-8 shadow-sm flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6 transition-colors duration-300">
        
        <div class="flex flex-col md:flex-row gap-4 w-full xl:w-auto">
            <div class="relative flex-1 md:flex-none">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" x-model="searchQuery" placeholder="Cari ID, Grade..." 
                       class="pl-10 pr-4 py-2 bg-gray-50 dark:bg-[#1a1a1a] border border-gray-200 dark:border-dark-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all w-full md:w-64 placeholder-gray-500 dark:text-white">
            </div>
            
            <div class="flex items-center gap-2 w-full md:w-auto">
                <input type="date" x-model="startDate" class="flex-1 px-3 py-2 bg-gray-50 dark:bg-[#1a1a1a] border border-gray-200 dark:border-dark-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 text-gray-700 dark:text-gray-300 dark:[color-scheme:dark]">
                <span class="text-gray-400">-</span>
                <input type="date" x-model="endDate" class="flex-1 px-3 py-2 bg-gray-50 dark:bg-[#1a1a1a] border border-gray-200 dark:border-dark-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 text-gray-700 dark:text-gray-300 dark:[color-scheme:dark]">
            </div>

            <!-- Date Range Dropdown -->
            <div class="relative flex-1 md:flex-none">
                <select x-model="dateRange" @change="applyDateRange()" class="w-full px-3 py-2 bg-gray-50 dark:bg-[#1a1a1a] border border-gray-200 dark:border-dark-border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 text-gray-700 dark:text-gray-300 cursor-pointer">
                    <option value="custom">Rentang Kustom</option>
                    <option value="7">7 Hari Terakhir</option>
                    <option value="14">14 Hari Terakhir</option>
                    <option value="30">30 Hari Terakhir</option>
                    <option value="90">3 Bulan Terakhir</option>
                    <option value="all">Semua Data</option>
                </select>
            </div>
        </div>

        <div class="flex flex-wrap gap-3 w-full xl:w-auto justify-end">
            <!-- Debug button
            <button @click="debug.show = !debug.show" class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                <i data-lucide="bug" class="w-4 h-4"></i>
                <span>Debug</span>
            </button>  -->
            
            <select x-model.number="pageSize" class="px-3 py-2 bg-gray-50 dark:bg-[#1a1a1a] border border-gray-200 dark:border-dark-border rounded-lg text-sm focus:outline-none text-gray-700 dark:text-gray-300 cursor-pointer">
                <option value="10">10 baris</option>
                <option value="30">30 baris</option>
                <option value="50">50 baris</option>
                <option value="100">100 baris</option>
            </select>

            <!-- Your existing column visibility and export buttons remain the same -->
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @click.outside="open = false"
                        class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-dark-border rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-white/5 transition-colors text-gray-700 dark:text-gray-200">
                    <i data-lucide="columns" class="w-4 h-4"></i>
                    <span>Tampilan Kolom</span>
                </button>
                
                <div x-show="open" x-transition class="absolute right-0 mt-2 w-56 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-xl shadow-xl z-50 p-3">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-100 dark:border-dark-border">
                        <span class="text-xs font-bold uppercase text-gray-500 dark:text-gray-400">Tampilkan Kolom</span>
                        <button @click="toggleAllColumns()" class="text-xs text-primary hover:underline">Semua</button>
                    </div>
                    <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                        <template x-for="(col, key) in columns" :key="key">
                            <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 p-1 rounded transition-colors">
                                <input type="checkbox" x-model="col.visible" class="rounded border-gray-300 text-primary focus:ring-primary bg-transparent">
                                <span class="text-sm text-gray-700 dark:text-gray-300" x-text="col.label"></span>
                            </label>
                        </template>
                    </div>
                </div>
            </div>

            <button @click="openExportModal()"
                    class="flex items-center gap-2 px-5 py-2 bg-primary text-black font-bold rounded-lg hover:bg-yellow-500 transition-colors shadow-sm">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span>Export</span>
            </button>
        </div>
    </div>

    <!-- Your existing table remains the same -->
    <div class="bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-2xl overflow-hidden shadow-sm mb-8 transition-colors duration-300">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 dark:bg-[#1a1a1a] text-xs uppercase text-gray-500 dark:text-gray-400 font-bold border-b border-gray-200 dark:border-dark-border">
                    <tr>
                        <template x-for="(col, key) in columns" :key="key">
                            <th x-show="col.visible" 
                                @click="sortBy(key)"
                                class="px-6 py-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/5 transition-colors select-none group whitespace-nowrap">
                                <div class="flex items-center gap-1">
                                    <span x-text="col.label"></span>
                                    <i data-lucide="arrow-up-down" class="w-3 h-3 opacity-30 group-hover:opacity-100 transition-opacity"
                                       :class="{'opacity-100 text-primary': sortCol === key}"></i>
                                </div>
                            </th>
                        </template>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-dark-border">
                    <template x-for="r in paginatedRows" :key="r.idNumerik">
                        <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group">
                            <td class="px-6 py-4 font-mono text-gray-400 dark:text-gray-500" x-show="columns.no.visible" x-text="r.no"></td>
                            <td class="px-6 py-4 font-bold font-mono text-gray-900 dark:text-gray-200" x-show="columns.idNumerik.visible" x-text="r.idNumerik"></td>
                            <td class="px-6 py-4 text-gray-500 dark:text-gray-400" x-show="columns.tanggal.visible" x-text="r.tanggal"></td>
                            <td class="px-6 py-4" x-show="columns.kategori.visible">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-yellow-700 dark:text-yellow-500 border border-primary/20" x-text="r.kategori"></span>
                            </td>
                            <td class="px-6 py-4 font-mono text-gray-700 dark:text-gray-300" x-show="columns.beratTelur.visible" x-text="r.beratTelur"></td>
                            <td class="px-6 py-4 text-gray-700 dark:text-gray-300" x-show="columns.kebersihan.visible" x-text="r.kebersihan"></td>
                            <td class="px-6 py-4 text-gray-700 dark:text-gray-300" x-show="columns.keutuhan.visible" x-text="r.keutuhan"></td>
                            <td class="px-6 py-4 text-right" x-show="columns.status.visible">
                                <span class="text-xs font-bold text-green-600 dark:text-green-400">OK</span>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredRows.length === 0">
                        <td :colspan="Object.values(columns).filter(c => c.visible).length" class="px-6 py-12 text-center text-gray-400 dark:text-gray-500 italic">
                            Tidak ada data yang cocok dengan filter.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="px-6 py-4 border-t border-gray-200 dark:border-dark-border bg-gray-50/50 dark:bg-[#1a1a1a] flex flex-col sm:flex-row justify-between items-center gap-4">
            
            <div class="flex items-center gap-4">
                <select x-model.number="pageSize" class="px-2 py-1 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded text-xs focus:outline-none text-gray-700 dark:text-gray-300">
                    <option value="10">10</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span class="text-xs text-gray-500 dark:text-gray-400">
                    Menampilkan <span x-text="paginationStart"></span> - <span x-text="paginationEnd"></span> dari <span x-text="filteredRows.length"></span> data
                </span>
            </div>

            <div class="flex gap-2">
                <button @click="currentPage--" :disabled="currentPage === 1" class="p-1.5 rounded border border-gray-200 dark:border-dark-border hover:bg-gray-200 dark:hover:bg-white/10 text-gray-600 dark:text-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>
                <div class="flex items-center gap-1 px-2">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-200" x-text="currentPage"></span>
                    <span class="text-xs text-gray-400">/ <span x-text="totalPages"></span></span>
                </div>
                <button @click="currentPage++" :disabled="currentPage >= totalPages" class="p-1.5 rounded border border-gray-200 dark:border-dark-border hover:bg-gray-200 dark:hover:bg-white/10 text-gray-600 dark:text-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-2xl p-6 shadow-sm mb-8 transition-colors duration-300">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h3 class="font-canela font-normal text-xl text-gray-900 dark:text-white">Visualisasi Data</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400" x-text="chartSubtitle"></p>
            </div>
            <div class="flex gap-2">
                <button @click="refreshChart()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Refresh Chart
                </button>
            </div>
        </div>
        
        <div class="h-[300px] w-full">
            <canvas id="histChart"></canvas>
        </div>
        
        <!-- Fallback message if no data -->
        <div x-show="filteredRows.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i data-lucide="bar-chart-3" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
            <p>Tidak ada data untuk ditampilkan dalam chart.</p>
        </div>
    </div>

    <!-- Export modal remains the same -->
    <div x-show="exportModalOpen" class="fixed inset-0 z-[60] flex items-center justify-center p-4" style="display: none;" x-cloak>
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="exportModalOpen = false" x-transition.opacity></div>
        
        <div class="relative w-full max-w-lg bg-white dark:bg-dark-surface rounded-2xl shadow-2xl overflow-hidden flex flex-col border border-gray-200 dark:border-dark-border"
             x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
            
            <div class="p-6 border-b border-gray-200 dark:border-dark-border bg-gray-50 dark:bg-[#1a1a1a] flex justify-between items-center">
                <h3 class="font-canela font-normal text-xl text-gray-900 dark:text-white">Export Data Laporan</h3>
                <button @click="exportModalOpen = false" class="text-gray-500 hover:text-black dark:hover:text-white transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="p-6 space-y-6 bg-white dark:bg-dark-surface">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 dark:text-gray-400 mb-2">Rentang Waktu Data</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-xs text-gray-400 mb-1 block">Dari</span>
                            <input type="date" x-model="exportConfig.start" class="w-full px-3 py-2 bg-gray-50 dark:bg-[#1a1a1a] border border-gray-200 dark:border-dark-border rounded-lg text-sm text-gray-700 dark:text-white focus:outline-none focus:border-primary dark:[color-scheme:dark]">
                        </div>
                        <div>
                            <span class="text-xs text-gray-400 mb-1 block">Sampai</span>
                            <input type="date" x-model="exportConfig.end" class="w-full px-3 py-2 bg-gray-50 dark:bg-[#1a1a1a] border border-gray-200 dark:border-dark-border rounded-lg text-sm text-gray-700 dark:text-white focus:outline-none focus:border-primary dark:[color-scheme:dark]">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 dark:text-gray-400 mb-2">Pilih Kolom untuk Export</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <template x-for="(col, key) in columns" :key="key">
                            <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-200 dark:border-dark-border rounded hover:bg-gray-50 dark:hover:bg-white/5 transition-colors" :class="{'border-primary bg-primary/5 dark:bg-primary/10': exportConfig.cols.includes(key)}">
                                <input type="checkbox" :value="key" x-model="exportConfig.cols" class="rounded text-primary focus:ring-primary bg-transparent">
                                <span class="text-xs font-medium text-gray-700 dark:text-gray-300" x-text="col.label"></span>
                            </label>
                        </template>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 dark:text-gray-400 mb-2">Format File</label>
                    <div class="flex gap-3">
                        <button @click="exportConfig.format = 'xlsx'" class="flex-1 py-3 border rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2" 
                                :class="exportConfig.format === 'xlsx' ? 'border-green-500 bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400' : 'border-gray-200 dark:border-dark-border text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-white/5'">
                            <i data-lucide="sheet" class="w-4 h-4"></i> Excel
                        </button>
                        <button @click="exportConfig.format = 'pdf'" class="flex-1 py-3 border rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2" 
                                :class="exportConfig.format === 'pdf' ? 'border-red-500 bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-400' : 'border-gray-200 dark:border-dark-border text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-white/5'">
                            <i data-lucide="file" class="w-4 h-4"></i> PDF
                        </button>
                        <button @click="exportConfig.format = 'csv'" class="flex-1 py-3 border rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2" 
                                :class="exportConfig.format === 'csv' ? 'border-blue-500 bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400' : 'border-gray-200 dark:border-dark-border text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-white/5'">
                            <i data-lucide="file-text" class="w-4 h-4"></i> CSV
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200 dark:border-dark-border bg-gray-50 dark:bg-[#1a1a1a] flex justify-end gap-3">
                <button @click="exportModalOpen = false" class="px-5 py-2.5 border border-gray-200 dark:border-dark-border rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-white/10 transition-colors">Batal</button>
                <button @click="executeExport()" class="px-5 py-2.5 bg-primary text-black font-bold rounded-lg hover:bg-yellow-500 transition-colors shadow-lg shadow-primary/20">
                    Unduh Sekarang
                </button>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    // Chart manager outside of Alpine to avoid reactivity issues
    class ChartManager {
        constructor() {
            this.chart = null;
            this.canvas = null;
            this.ctx = null;
        }

        init(canvasId) {
            this.canvas = document.getElementById(canvasId);
            if (!this.canvas) {
                console.error('Canvas not found:', canvasId);
                return false;
            }

            this.ctx = this.canvas.getContext('2d');
            
            // Destroy existing chart
            if (this.chart) {
                this.chart.destroy();
            }

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#ffffff' : '#333333';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            // Define colors for each grade
            const gradeColors = {
                'A': 'rgba(34, 197, 94, 0.8)',    // Green
                'B': 'rgba(59, 130, 246, 0.8)',   // Blue
                'C': 'rgba(245, 158, 11, 0.8)',   // Amber
                'Retak': 'rgba(239, 68, 68, 0.8)' // Red
            };

            const gradeBorders = {
                'A': '#16a34a',
                'B': '#2563eb', 
                'C': '#d97706',
                'Retak': '#dc2626'
            };

            try {
                this.chart = new Chart(this.ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top',
                                labels: {
                                    color: textColor,
                                    usePointStyle: true,
                                    pointStyle: 'rect',
                                    padding: 20,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.95)',
                                titleColor: textColor,
                                bodyColor: textColor,
                                borderColor: '#FFD700',
                                borderWidth: 1,
                                cornerRadius: 6,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        return `${label}: ${value} butir`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                stacked: true,
                                grid: { color: gridColor },
                                ticks: { 
                                    color: textColor,
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : '';
                                    }
                                }
                            },
                            x: {
                                stacked: true,
                                grid: { display: false },
                                ticks: { 
                                    color: textColor,
                                    maxRotation: 45
                                }
                            }
                        },
                        animation: {
                            duration: 800,
                            easing: 'easeOutQuart'
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
                return true;
            } catch (error) {
                console.error('Chart initialization failed:', error);
                return false;
            }
        }

        updateData(labels, datasets) {
            if (!this.chart) {
                console.warn('Chart not initialized');
                return false;
            }

            try {
                // Update data directly without triggering full reactivity
                this.chart.data.labels = labels;
                this.chart.data.datasets = datasets;

                // Update colors for current theme
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#ffffff' : '#333333';
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

                this.chart.options.scales.y.ticks.color = textColor;
                this.chart.options.scales.x.ticks.color = textColor;
                this.chart.options.scales.y.grid.color = gridColor;
                this.chart.options.plugins.legend.labels.color = textColor;
                this.chart.options.plugins.tooltip.backgroundColor = isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.95)';
                this.chart.options.plugins.tooltip.titleColor = textColor;
                this.chart.options.plugins.tooltip.bodyColor = textColor;

                // Use requestAnimationFrame to avoid call stack issues
                requestAnimationFrame(() => {
                    this.chart.update();
                });
                
                return true;
            } catch (error) {
                console.error('Chart update failed:', error);
                return false;
            }
        }

        destroy() {
            if (this.chart) {
                this.chart.destroy();
                this.chart = null;
            }
        }
    }

    // Global chart manager instance
    const chartManager = new ChartManager();

    document.addEventListener('alpine:init', () => {
        Alpine.data('laporanData', () => ({
            // State Filters
            startDate: '',
            endDate: '',
            searchQuery: '',
            dateRange: '30', // Default to 30 days
            
            // Data Table
            allRows: {{ records | tojson }},
            
            // Debug info
            debug: {
                show: true,
                chartData: {},
                chartInitialized: false
            },
            
            // Pagination
            pageSize: 10,
            currentPage: 1,
            
            // Sorting
            sortCol: 'no',
            sortAsc: true,

            // Column Config
            columns: {
                no: { label: 'No', visible: true },
                idNumerik: { label: 'ID Numerik', visible: true },
                tanggal: { label: 'Waktu Scan', visible: true },
                kategori: { label: 'Grade', visible: true },
                beratTelur: { label: 'Berat (g)', visible: true },
                kebersihan: { label: 'Kebersihan', visible: true },
                keutuhan: { label: 'Keutuhan', visible: true },
                status: { label: 'Status', visible: true },
            },

            // Export State
            exportModalOpen: false,
            exportConfig: {
                start: '',
                end: '',
                cols: ['no', 'idNumerik', 'tanggal', 'kategori', 'beratTelur', 'kebersihan', 'keutuhan'],
                format: 'xlsx'
            },

            // --- COMPUTED PROPERTIES ---
            get chartSubtitle() {
                const rangeTexts = {
                    '7': '7 Hari Terakhir',
                    '14': '14 Hari Terakhir', 
                    '30': '30 Hari Terakhir',
                    '90': '3 Bulan Terakhir',
                    'all': 'Semua Data',
                    'custom': 'Rentang Kustom'
                };
                return `Distribusi Grade per Hari - ${rangeTexts[this.dateRange]}`;
            },

            // --- INIT ---
            init() {
                console.log('ðŸš€ Initializing laporanData with records:', this.allRows.length);
                
                // Set default date range to 30 days
                this.applyDateRange();

                // Initialize chart after Alpine is ready
                this.$nextTick(() => {
                    setTimeout(() => {
                        this.initChart();
                    }, 500);
                });

                // Watch for data changes with debouncing
                let updateTimeout;
                this.$watch('filteredRows', () => {
                    clearTimeout(updateTimeout);
                    updateTimeout = setTimeout(() => {
                        this.updateChart();
                    }, 200);
                });

                // Watch for date range changes
                this.$watch('dateRange', () => {
                    this.applyDateRange();
                });
            },

            // --- METHODS ---
            applyDateRange() {
                if (this.dateRange === 'custom') {
                    // Don't change dates if custom range is selected
                    return;
                }

                const today = new Date();
                const startDate = new Date();

                if (this.dateRange === 'all') {
                    this.startDate = '';
                    this.endDate = '';
                } else {
                    const days = parseInt(this.dateRange);
                    startDate.setDate(today.getDate() - days);
                    
                    this.startDate = startDate.toISOString().split('T')[0];
                    this.endDate = today.toISOString().split('T')[0];
                }
            },

            // Parse date from string (handles DD/MM/YYYY format)
            parseDate(dateStr) {
                if (!dateStr) return null;
                
                // Handle DD/MM/YYYY format
                if (dateStr.includes('/')) {
                    const parts = dateStr.split(' ')[0].split('/');
                    if (parts.length === 3) {
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }
                
                // Try parsing as ISO string
                return new Date(dateStr);
            },

            // Format date to YYYY-MM-DD
            formatDate(date) {
                return date.toISOString().split('T')[0];
            },

            // --- COMPUTED PROPERTIES ---
            get filteredRows() {
                let data = this.allRows;

                // 1. Date Filter
                if (this.startDate) {
                    const start = new Date(this.startDate);
                    start.setHours(0,0,0,0);
                    data = data.filter(r => {
                        const rDate = this.parseDate(r.tanggal);
                        return rDate && rDate >= start;
                    });
                }
                if (this.endDate) {
                    const end = new Date(this.endDate);
                    end.setHours(23,59,59,999);
                    data = data.filter(r => {
                        const rDate = this.parseDate(r.tanggal);
                        return rDate && rDate <= end;
                    });
                }

                // 2. Search Filter
                if (this.searchQuery) {
                    const q = this.searchQuery.toLowerCase();
                    data = data.filter(row => {
                        return Object.values(row).some(val => 
                            val && String(val).toLowerCase().includes(q)
                        );
                    });
                }

                // 3. Sorting
                return data.sort((a, b) => {
                    let valA = a[this.sortCol];
                    let valB = b[this.sortCol];
                    
                    if (valA === null || valA === undefined) valA = '';
                    if (valB === null || valB === undefined) valB = '';
                    
                    if (!isNaN(parseFloat(valA)) && isFinite(valA)) {
                        valA = parseFloat(valA);
                        valB = parseFloat(valB);
                    } else {
                        valA = String(valA).toLowerCase();
                        valB = String(valB).toLowerCase();
                    }

                    if (valA < valB) return this.sortAsc ? -1 : 1;
                    if (valA > valB) return this.sortAsc ? 1 : -1;
                    return 0;
                });
            },

            get paginatedRows() {
                const start = (this.currentPage - 1) * this.pageSize;
                const end = start + this.pageSize;
                return this.filteredRows.slice(start, end);
            },

            get totalPages() {
                return Math.ceil(this.filteredRows.length / this.pageSize) || 1;
            },

            get paginationStart() {
                if (this.filteredRows.length === 0) return 0;
                return (this.currentPage - 1) * this.pageSize + 1;
            },

            get paginationEnd() {
                return Math.min(this.currentPage * this.pageSize, this.filteredRows.length);
            },

            // --- ACTIONS ---
            sortBy(key) {
                if (this.sortCol === key) {
                    this.sortAsc = !this.sortAsc;
                } else {
                    this.sortCol = key;
                    this.sortAsc = true;
                }
            },

            toggleAllColumns() {
                const allVisible = Object.values(this.columns).every(c => c.visible);
                Object.keys(this.columns).forEach(key => {
                    this.columns[key].visible = !allVisible;
                });
            },

            openExportModal() {
                this.exportConfig.start = this.startDate || new Date().toISOString().split('T')[0];
                this.exportConfig.end = this.endDate || new Date().toISOString().split('T')[0];
                this.exportModalOpen = true;
            },

            refreshChart() {
                console.log('ðŸ”„ Manual chart refresh');
                this.initChart();
            },

            // --- CHART METHODS ---
            initChart() {
                console.log('ðŸŽ¯ Initializing chart...');
                const success = chartManager.init('histChart');
                this.debug.chartInitialized = success;
                
                if (success) {
                    console.log('âœ… Chart initialized successfully');
                    this.updateChart();
                } else {
                    console.error('âŒ Chart initialization failed');
                }
            },

            updateChart() {
                console.log('ðŸ”„ Updating chart data...');
                
                // Define all possible grades
                const allGrades = ['A', 'B', 'C', 'Retak'];
                
                // Define colors for each grade
                const gradeColors = {
                    'A': 'rgba(34, 197, 94, 0.8)',    // Green
                    'B': 'rgba(59, 130, 246, 0.8)',   // Blue
                    'C': 'rgba(245, 158, 11, 0.8)',   // Amber
                    'Retak': 'rgba(239, 68, 68, 0.8)' // Red
                };

                const gradeBorders = {
                    'A': '#16a34a',
                    'B': '#2563eb',
                    'C': '#d97706',
                    'Retak': '#dc2626'
                };

                // Aggregate data by date and grade
                const dailyData = {};
                
                this.filteredRows.forEach(r => {
                    const dateObj = this.parseDate(r.tanggal);
                    if (dateObj) {
                        const dateKey = this.formatDate(dateObj);
                        const grade = r.kategori || 'Unknown';
                        
                        if (!dailyData[dateKey]) {
                            dailyData[dateKey] = { A: 0, B: 0, C: 0, Retak: 0 };
                        }
                        
                        // Only count known grades
                        if (allGrades.includes(grade)) {
                            dailyData[dateKey][grade] = (dailyData[dateKey][grade] || 0) + 1;
                        }
                    }
                });

                // Sort dates and prepare chart data
                const sortedDates = Object.keys(dailyData).sort();
                const labels = sortedDates.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('id-ID', { 
                        day: '2-digit', 
                        month: '2-digit',
                        year: 'numeric'
                    });
                });

                // Create datasets for each grade
                const datasets = allGrades.map(grade => ({
                    label: `Grade ${grade}`,
                    data: sortedDates.map(date => dailyData[date][grade] || 0),
                    backgroundColor: gradeColors[grade],
                    borderColor: gradeBorders[grade],
                    borderWidth: 2,
                    borderRadius: 4,
                    barPercentage: 0.8,
                    categoryPercentage: 0.9
                }));

                this.debug.chartData = { labels, datasets };

                console.log('ðŸ“ˆ Chart data to display:', { labels, datasets });

                // Update chart via manager
                const success = chartManager.updateData(labels, datasets);
                
                if (success) {
                    console.log('âœ… Chart updated successfully');
                } else {
                    console.error('âŒ Chart update failed');
                }
            },

            // --- EXPORT LOGIC ---
            executeExport() {
                // 1. Filter Data based on export Modal Dates (not main filter)
                let dataToExport = this.allRows;
                
                const start = new Date(this.exportConfig.start); 
                start.setHours(0,0,0,0);
                const end = new Date(this.exportConfig.end); 
                end.setHours(23,59,59,999);

                dataToExport = dataToExport.filter(r => {
                    let dateStr = r.tanggal;
                    if (dateStr.includes('/')) {
                         const parts = dateStr.split(' ')[0].split('/');
                         if (parts.length === 3) dateStr = `${parts[1]}/${parts[0]}/${parts[2]}`;
                    }
                    const rDate = new Date(dateStr);
                    return rDate >= start && rDate <= end;
                });

                // 2. Map to selected columns
                const finalData = dataToExport.map(row => {
                    const mapped = {};
                    this.exportConfig.cols.forEach(key => {
                        mapped[this.columns[key].label] = row[key];
                    });
                    return mapped;
                });

                if (finalData.length === 0) {
                    alert("Tidak ada data pada rentang tanggal tersebut.");
                    return;
                }

                const filename = `Laporan_EggVision_${this.exportConfig.start}_to_${this.exportConfig.end}`;

                if (this.exportConfig.format === 'xlsx') {
                    const ws = XLSX.utils.json_to_sheet(finalData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Laporan');
                    XLSX.writeFile(wb, `${filename}.xlsx`);
                } else if (this.exportConfig.format === 'csv') {
                    const ws = XLSX.utils.json_to_sheet(finalData);
                    const csv = XLSX.utils.sheet_to_csv(ws);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `${filename}.csv`;
                    link.click();
                } else if (this.exportConfig.format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text('Laporan Produksi EggVision', 14, 15);
                    doc.text(`Periode: ${this.exportConfig.start} - ${this.exportConfig.end}`, 14, 22);
                    
                    const headers = [this.exportConfig.cols.map(key => this.columns[key].label)];
                    const body = finalData.map(obj => Object.values(obj));

                    doc.autoTable({
                        head: headers,
                        body: body,
                        startY: 30,
                    });
                    doc.save(`${filename}.pdf`);
                }

                this.exportModalOpen = false;
            }
        }));
    });

    // Ensure everything loads properly
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸ  DOM fully loaded');
        if (window.lucide) {
            lucide.createIcons();
        }
    });
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        chartManager.destroy();
    });
</script>
{% endblock %}