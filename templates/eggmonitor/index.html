{% extends "eggmonitor/base.html" %}

{% block page_title %}Dashboard Produksi{% endblock %}
{% block page_subtitle %}Pantau performa alat dan produksi telur{% endblock %}

{% block content %}
<div x-data="dashboardData">

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <div class="bg-card bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm flex flex-col justify-between h-full transition-colors">
            <div class="flex justify-between items-start mb-4">
                <h3 class="font-canela font-normal text-xl text-foreground dark:text-white">Distribusi Kualitas Telur</h3>
            </div>
            
            <div class="flex flex-col md:flex-row items-center gap-8">
                <div class="relative w-48 h-48 flex-shrink-0">
                    <canvas id="qualityDonutChart"></canvas>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span class="text-2xl font-bold text-foreground dark:text-white">{{ "{:,}".format(grades_total) }}</span>
                        <span class="text-[10px] text-gray-400 uppercase tracking-wider">Total</span>
                    </div>
                </div>

                <div class="flex-1 w-full grid grid-cols-2 gap-3">
                    {% for g in grades %}
                    <div class="flex flex-col p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-border dark:border-dark-border transition-colors">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full" style="background-color: {{ g.color }}"></span>
                            <span class="text-xs font-bold uppercase text-gray-500">{{ g.label }}</span>
                        </div>
                        <div class="flex items-end justify-between">
                            <span class="text-lg font-bold text-foreground dark:text-white">{{ g.count }}</span>
                            <span class="text-[10px] font-mono opacity-70 text-gray-500">{{ g.percentage }}%</span>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="flex flex-col p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-border dark:border-dark-border transition-colors">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="w-2.5 h-2.5 rounded-full bg-gray-400"></span>
                            <span class="text-xs font-bold uppercase text-gray-500">Retak</span>
                        </div>
                        <div class="flex items-end justify-between">
                            <span class="text-lg font-bold text-foreground dark:text-white">0</span>
                            <span class="text-[10px] font-mono opacity-70 text-gray-500">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-card bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm h-full overflow-y-auto custom-scrollbar max-h-[400px] transition-colors">
            <h3 class="font-canela font-normal text-xl mb-4 text-foreground dark:text-white">Notifikasi Sistem</h3>
            <div class="space-y-3">
                {% for n in notifications %}
                <div class="flex items-start justify-between bg-gray-50 dark:bg-white/5 border border-border dark:border-dark-border rounded-xl px-4 py-3 transition-colors">
                    <div class="flex items-start gap-3">
                        <div class="mt-0.5 p-1.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
                            <i data-lucide="info" class="w-3.5 h-3.5"></i>
                        </div>
                        <p class="text-sm text-gray-700 dark:text-gray-300 leading-snug">{{ n.message }}</p>
                    </div>
                    <button class="text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                </div>
                {% else %}
                <div class="flex flex-col items-center justify-center h-32 text-gray-400 text-sm italic">
                    <i data-lucide="bell-off" class="w-8 h-8 mb-2 opacity-50"></i>
                    Tidak ada notifikasi baru.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        
        <div class="bg-card bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm h-full flex flex-col transition-colors">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="font-canela font-normal text-xl text-foreground dark:text-white">Analisis Manual</h3>
                    <p class="text-xs text-gray-500 mt-1">Unggah foto telur untuk grading AI.</p>
                </div>
            </div>

            <form action="{{ url_for('eggmonitor_controller.upload') }}" method="POST" enctype="multipart/form-data" class="space-y-4 flex-1 flex flex-col">
                <div class="relative w-full aspect-video bg-gray-100 dark:bg-black/40 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 flex flex-col items-center justify-center overflow-hidden group hover:border-primary transition-colors cursor-pointer flex-1"
                     onclick="document.getElementById('fileInput').click()">
                    
                    <template x-if="!imagePreview">
                        <div class="text-center pointer-events-none">
                            <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400 mx-auto mb-2 group-hover:text-primary transition-colors"></i>
                            <span class="text-xs text-gray-500">Klik upload gambar</span>
                        </div>
                    </template>

                    <template x-if="imagePreview">
                        <img :src="imagePreview" class="absolute inset-0 w-full h-full object-contain bg-black/5">
                    </template>

                    <input type="file" name="file" id="fileInput" accept="image/*" required 
                           class="hidden" @change="handleFileUpload">
                </div>

                {% if prediction %}
                <div class="mt-auto p-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-900 text-center">
                    <p class="text-[10px] font-bold uppercase text-green-600 dark:text-green-400 mb-1">Hasil Prediksi</p>
                    <div class="text-lg font-canela text-foreground dark:text-white">{{ prediction }}</div>
                    <div class="text-xs text-gray-500 mt-1">Akurasi: {{ confidence }}</div>
                </div>
                {% endif %}

                <button type="submit" class="w-full py-2.5 bg-primary text-black font-bold rounded-lg hover:bg-yellow-500 transition-all text-sm shadow-md mt-auto">
                    Mulai Analisis
                </button>
            </form>
        </div>

        <div class="bg-card bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm h-full flex flex-col transition-colors">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="font-canela font-normal text-xl text-foreground dark:text-white">Status Perangkat</h3>
                    <p class="text-xs text-gray-500 mt-1">Monitoring sensor & aktuator.</p>
                </div>
                <div class="flex gap-3">
                    <a href="{{ url_for('eggmonitor_controller.detail_alat') }}" 
                       class="px-4 py-2 bg-primary text-black font-bold rounded-lg text-xs flex items-center gap-2 hover:bg-yellow-500 transition-colors shadow-sm">
                        Lihat Selengkapnya <i data-lucide="arrow-right" class="w-3 h-3"></i>
                    </a>
                </div>
            </div>

            <div class="space-y-4 overflow-y-auto custom-scrollbar flex-1 max-h-[400px] pr-1">
                <template x-for="group in iotGroups" :key="group.id">
                    <div class="p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-border dark:border-dark-border transition-colors">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <div class="p-2 rounded-full" :class="group.isOn ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400'">
                                    <i :data-lucide="group.icon" class="w-4 h-4"></i>
                                </div>
                                <span class="font-bold text-sm text-foreground dark:text-white" x-text="group.label"></span>
                            </div>
                            <button @click="toggleGroup(group.id)" 
                                    class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none"
                                    :class="group.isOn ? 'bg-primary' : 'bg-gray-300 dark:bg-gray-600'">
                                <span class="inline-block h-3 w-3 transform rounded-full bg-white transition duration-200 translate-x-1"
                                      :class="group.isOn ? 'translate-x-5' : 'translate-x-1'"></span>
                            </button>
                        </div>

                        <div class="pl-11 space-y-2 mt-2 border-t border-dashed border-gray-200 dark:border-gray-700 pt-2" x-show="group.children.length > 0">
                            <template x-for="child in group.children" :key="child.id">
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500 dark:text-gray-400" x-text="child.label"></span>
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono text-[10px]" :class="child.isOn ? 'text-green-500' : 'text-red-500'" x-text="child.isOn ? 'ON' : 'OFF'"></span>
                                        <button @click="toggleChild(group.id, child.id)" 
                                                class="relative inline-flex h-4 w-7 items-center rounded-full transition-colors focus:outline-none"
                                                :class="child.isOn ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600'">
                                            <span class="inline-block h-2 w-2 transform rounded-full bg-white transition duration-200 translate-x-1"
                                                  :class="child.isOn ? 'translate-x-4' : 'translate-x-1'"></span>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>

    </div>

    <div class="bg-card bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm transition-colors">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4">
            <div>
                <h3 class="font-canela font-normal text-2xl text-foreground dark:text-white">Data Scan Terbaru</h3>
                <p class="text-sm text-gray-500">Menampilkan 10 data terakhir.</p>
            </div>
            <div class="flex gap-3">
                <a href="{{ url_for('eggmonitor_controller.eggmonitor_laporan') }}" 
                   class="px-4 py-2 bg-primary text-black font-bold rounded-lg text-xs flex items-center gap-2 hover:bg-yellow-500 transition-colors shadow-sm">
                    Lihat Selengkapnya <i data-lucide="arrow-right" class="w-3 h-3"></i>
                </a>
            </div>
        </div>

        <div class="overflow-x-auto rounded-lg border border-border dark:border-dark-border">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 dark:bg-white/5 text-xs uppercase text-gray-500 font-bold border-b border-border dark:border-dark-border">
                    <tr>
                        <th @click="sortBy('no')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">
                            No <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1 opacity-50"></i>
                        </th>
                        <th @click="sortBy('idNumerik')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">ID Numerik</th>
                        <th @click="sortBy('tanggal')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">Tanggal</th>
                        <th @click="sortBy('ketebalan')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">Ketebalan</th>
                        <th @click="sortBy('kebersihan')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">Kebersihan</th>
                        <th @click="sortBy('keutuhan')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">Keutuhan</th>
                        <th @click="sortBy('beratTelur')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">Berat (g)</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border dark:divide-dark-border">
                    <template x-for="r in sortedRows" :key="r.idNumerik">
                        <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group">
                            <td class="px-4 py-3 font-mono text-xs text-gray-600 dark:text-gray-400 whitespace-nowrap" x-text="r.no"></td>
                            <td class="px-4 py-3 font-bold font-mono text-foreground dark:text-white whitespace-nowrap" x-text="r.idNumerik"></td>
                            <td class="px-4 py-3 text-gray-500 dark:text-gray-400 whitespace-nowrap" x-text="r.tanggal"></td>
                            <td class="px-4 py-3 text-foreground dark:text-white whitespace-nowrap" x-text="r.ketebalan"></td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="px-2 py-0.5 rounded text-xs font-bold"
                                      :class="String(r.kebersihan).toLowerCase().includes('bersih') ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'"
                                      x-text="r.kebersihan"></span>
                            </td>
                            <td class="px-4 py-3 text-foreground dark:text-white whitespace-nowrap" x-text="r.keutuhan"></td>
                            <td class="px-4 py-3 font-mono text-foreground dark:text-white whitespace-nowrap" x-text="r.beratTelur"></td>
                        </tr>
                    </template>
                    <tr x-show="sortedRows.length === 0">
                        <td colspan="7" class="px-4 py-8 text-center text-gray-400 italic">Belum ada data scan.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('dashboardData', () => ({
        imagePreview: '{{ uploaded_image or '' }}',
        
        // --- Table Data & Sorting ---
        tableData: {{ records | tojson }},
        sortCol: 'scanned_at',
        sortAsc: false,

        // --- IoT Data Logic ---
        iotGroups: [
            {
                id: 'conveyor', label: 'Konveyor Utama', icon: 'settings-2', isOn: true,
                children: [
                    { id: 'motor', label: 'Motor Konveyor', isOn: true },
                    { id: 'proximity', label: 'Sensor Proximity', isOn: true }
                ]
            },
            {
                id: 'vision', label: 'Vision Camera', icon: 'camera', isOn: true,
                children: [
                    { id: 'camA1', label: 'Kamera A1 (Kanan)', isOn: true },
                    { id: 'camA2', label: 'Kamera A2 (Tengah)', isOn: true },
                    { id: 'camA3', label: 'Kamera A3 (Kiri)', isOn: true }
                ]
            },
            {
                id: 'loadcell', label: 'Load Cell', icon: 'scale', isOn: true,
                children: [
                    { id: 'load1', label: 'Load Cell 1', isOn: true },
                    { id: 'load2', label: 'Load Cell 2', isOn: true }
                ]
            }
        ],

        toggleGroup(groupId) {
            const group = this.iotGroups.find(g => g.id === groupId);
            if(group) {
                group.isOn = !group.isOn;
                group.children.forEach(child => child.isOn = group.isOn);
            }
        },

        toggleChild(groupId, childId) {
            const group = this.iotGroups.find(g => g.id === groupId);
            if(group) {
                const child = group.children.find(c => c.id === childId);
                if(child) child.isOn = !child.isOn;
                const anyOn = group.children.some(c => c.isOn);
                group.isOn = anyOn;
            }
        },

        handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                this.imagePreview = URL.createObjectURL(file);
            }
        },

        sortBy(col) {
            if (this.sortCol === col) {
                this.sortAsc = !this.sortAsc;
            } else {
                this.sortCol = col;
                this.sortAsc = true;
            }
        },

        get sortedRows() {
            return this.tableData.sort((a, b) => {
                let valA = a[this.sortCol];
                let valB = b[this.sortCol];
                
                if (valA == null) valA = '';
                if (valB == null) valB = '';

                if (!isNaN(parseFloat(valA)) && isFinite(valA) && !isNaN(parseFloat(valB)) && isFinite(valB)) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return this.sortAsc ? -1 : 1;
                if (valA > valB) return this.sortAsc ? 1 : -1;
                return 0;
            }).slice(0, 10); 
        }
    }));
});

// --- CHART.JS INITIALIZATION ---
document.addEventListener("DOMContentLoaded", () => {
    if (window.lucide) lucide.createIcons();

    const ctx = document.getElementById('qualityDonutChart').getContext('2d');
    const isDark = document.documentElement.classList.contains('dark');

    const gradesData = [
        {% for g in grades %}{{ g.count }},{% endfor %} 0 
    ];
    const bgColors = [
        {% for g in grades %}'{{ g.color }}',{% endfor %} '#94a3b8'
    ];
    const labels = [
        {% for g in grades %}'{{ g.label }}',{% endfor %} 'Retak'
    ];

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: gradesData,
                backgroundColor: bgColors,
                borderWidth: 0,
                hoverOffset: 10,  // REMOVED default offset, kept hover
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    enabled: true, // Ensure tooltips are ON
                    backgroundColor: isDark ? '#1a1a1a' : '#fff',
                    titleColor: isDark ? '#fff' : '#000',
                    bodyColor: isDark ? '#ccc' : '#666',
                    borderColor: isDark ? '#333' : '#eee',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: true,
                    boxWidth: 8,
                    boxHeight: 8,
                    usePointStyle: true,
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) { label += ': '; }
                            let value = context.raw || 0;
                            let total = context.chart._metasets[context.datasetIndex].total;
                            let percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                            return label + value + ' (' + percentage + ')';
                        }
                    }
                }
            },
            // Disable hover offset effect if you specifically meant that
            hover: {
                mode: null 
            }
        }
    });
});
</script>
{% endblock %}