{% extends "eggmonitor/base.html" %}

{% block page_title %}Dashboard Produksi{% endblock %}
{% block page_subtitle %}Pantau performa alat dan produksi telur{% endblock %}

{% block content %}
<div x-data="dashboardData">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        
        <div class="lg:col-span-2 space-y-6">
            
            <div class="bg-card bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm transition-colors duration-300">
                <h3 class="font-canela font-normal text-xl mb-6 text-foreground dark:text-white">Distribusi Kualitas Telur</h3>
                
                <div class="flex flex-col md:flex-row items-center gap-10">
                    <div class="relative w-56 h-56 flex-shrink-0">
                        {% set chart_gradient = [] %}
                        {% set current_deg = 0 %}
                        {% for g in grades %}
                             {% set deg = (g.percentage / 100) * 360 %}
                             {% set next_deg = current_deg + deg %}
                             {% set _ = chart_gradient.append(g.color ~ ' ' ~ current_deg ~ 'deg ' ~ next_deg ~ 'deg') %}
                             {% set current_deg = next_deg %}
                        {% endfor %}
                        {% set _ = chart_gradient.append('#94a3b8 ' ~ current_deg ~ 'deg 360deg') %}
                        
                        <div class="w-full h-full rounded-full shadow-inner"
                             style="background: conic-gradient({{ chart_gradient|join(', ') }});">
                        </div>
                        
                        <div class="absolute inset-0 m-auto w-36 h-36 bg-white dark:bg-dark-surface rounded-full flex flex-col items-center justify-center shadow-sm transition-colors duration-300">
                            <span class="text-3xl font-bold text-foreground dark:text-white">{{ "{:,}".format(grades_total) }}</span>
                            <span class="text-xs text-gray-400 uppercase tracking-wider">Total Telur</span>
                        </div>
                    </div>

                    <div class="flex-1 w-full grid grid-cols-2 gap-4">
                        {% for g in grades %}
                        <div class="flex flex-col p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-border dark:border-dark-border transition-colors">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-3 h-3 rounded-full" style="background-color: {{ g.color }}"></span>
                                <span class="text-xs font-bold uppercase text-gray-500">{{ g.label }}</span>
                            </div>
                            <div class="flex items-end justify-between">
                                <span class="text-xl font-bold text-foreground dark:text-white">{{ g.count }}</span>
                                <span class="text-xs font-mono opacity-70 text-gray-500">{{ g.percentage }}%</span>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="flex flex-col p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-border dark:border-dark-border opacity-60 transition-colors">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-3 h-3 rounded-full bg-slate-400"></span>
                                <span class="text-xs font-bold uppercase text-gray-500">Reject / Error</span>
                            </div>
                            <div class="flex items-end justify-between">
                                <span class="text-xl font-bold text-foreground dark:text-white">--</span>
                                <span class="text-xs font-mono opacity-70 text-gray-500">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <h3 class="font-canela font-normal text-xl mb-2 text-foreground dark:text-white">Notifikasi Sistem</h3>
                {% for n in notifications %}
                <div class="flex items-center justify-between bg-white dark:bg-white/5 border border-blue-200 dark:border-blue-900/50 rounded-xl px-5 py-3 shadow-sm transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="p-2 rounded-full bg-blue-50 text-blue-500 dark:bg-blue-900/30 dark:text-blue-300"><i data-lucide="info" class="w-4 h-4"></i></div>
                        <span class="text-sm text-gray-700 dark:text-gray-300">{{ n.message }}</span>
                    </div>
                    <button class="text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                {% else %}
                <div class="text-sm text-gray-400 italic">Tidak ada notifikasi baru.</div>
                {% endfor %}
             </div>

        </div>

        <div class="space-y-6">
            
            <div class="bg-card bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm h-fit transition-colors">
                <h3 class="font-canela font-normal text-xl mb-4 text-foreground dark:text-white">Analisis Manual</h3>
                <form action="{{ url_for('eggmonitor_controller.upload') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
                    
                    <div class="relative w-full aspect-video bg-gray-100 dark:bg-black/40 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 flex flex-col items-center justify-center overflow-hidden group hover:border-primary transition-colors">
                        
                        <template x-if="!imagePreview">
                            <div class="text-center pointer-events-none p-4">
                                <i data-lucide="upload-cloud" class="w-10 h-10 text-gray-400 mx-auto mb-2 group-hover:text-primary transition-colors"></i>
                                <span class="text-xs text-gray-500">Klik untuk upload gambar</span>
                            </div>
                        </template>

                        <template x-if="imagePreview">
                            <img :src="imagePreview" class="absolute inset-0 w-full h-full object-contain bg-black/5">
                        </template>

                        <input type="file" name="file" accept="image/*" required 
                               class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                               @change="handleFileUpload">
                    </div>

                    <button type="submit" class="w-full py-3 bg-primary text-black font-bold rounded-xl hover:bg-yellow-400 transition-all transform active:scale-95 shadow-lg shadow-primary/20">
                        Analisis Sekarang
                    </button>
                </form>

                {% if prediction %}
                <div class="mt-6 pt-4 border-t border-border dark:border-dark-border text-center">
                    <p class="text-xs font-bold uppercase text-gray-500 mb-1">Hasil Prediksi</p>
                    <div class="text-xl font-canela text-primary mb-1">{{ prediction }}</div>
                    <div class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-full text-xs font-bold">
                        <i data-lucide="check-circle" class="w-3 h-3"></i> {{ confidence }}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="bg-card bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm transition-colors">
                <h3 class="font-canela font-normal text-xl mb-4 text-foreground dark:text-white">Status Perangkat IoT</h3>
                <div class="space-y-3">
                    {% for item in status_items %}
                    <div class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-white/5 border border-border dark:border-dark-border transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full {{ 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' if item.is_on else 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' }}">
                                <i data-lucide="{{ 'activity' if item.is_on else 'power-off' }}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-foreground dark:text-white">{{ item.label }}</p>
                                <p class="text-[10px] text-gray-500">{{ 'Berjalan Normal' if item.is_on else 'Nonaktif' }}</p>
                            </div>
                        </div>
                        <div class="w-3 h-3 rounded-full {{ 'bg-green-500 animate-pulse' if item.is_on else 'bg-red-500' }}"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>

    <div class="bg-card bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm transition-colors">
        <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
            <div>
                <h3 class="font-canela font-normal text-2xl text-foreground dark:text-white">Data Scan Terbaru</h3>
                <p class="text-sm text-gray-500">Menampilkan 10 data terakhir dari mesin.</p>
            </div>
            <button class="p-2 rounded-lg bg-gray-100 dark:bg-white/10 hover:bg-primary hover:text-black text-gray-600 dark:text-gray-300 transition-colors">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="overflow-x-auto rounded-lg border border-border dark:border-dark-border">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 dark:bg-white/5 text-xs uppercase text-gray-500 font-bold border-b border-border dark:border-dark-border">
                    <tr>
                        <th @click="sortBy('no')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">
                            No <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1 opacity-50"></i>
                        </th>
                        <th @click="sortBy('idNumerik')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">
                            ID Numerik
                        </th>
                        <th @click="sortBy('tanggal')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">
                            Tanggal
                        </th>
                        <th @click="sortBy('ketebalan')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">
                            Ketebalan
                        </th>
                        <th @click="sortBy('kebersihan')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">
                            Kebersihan
                        </th>
                        <th @click="sortBy('keutuhan')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">
                            Keutuhan
                        </th>
                        <th @click="sortBy('beratTelur')" class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors select-none whitespace-nowrap">
                            Berat (g)
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-dark-border">
                    <template x-for="r in sortedRows" :key="r.idNumerik">
                        <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group">
                            <td class="px-4 py-3 font-mono text-xs text-gray-600 dark:text-gray-400 whitespace-nowrap" x-text="r.no"></td>
                            <td class="px-4 py-3 font-bold font-mono text-foreground dark:text-white whitespace-nowrap" x-text="r.idNumerik"></td>
                            <td class="px-4 py-3 text-gray-500 dark:text-gray-400 whitespace-nowrap" x-text="r.tanggal"></td>
                            <td class="px-4 py-3 text-foreground dark:text-white whitespace-nowrap" x-text="r.ketebalan"></td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="px-2 py-0.5 rounded text-xs font-bold"
                                      :class="String(r.kebersihan).toLowerCase().includes('bersih') ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'"
                                      x-text="r.kebersihan"></span>
                            </td>
                            <td class="px-4 py-3 text-foreground dark:text-white whitespace-nowrap" x-text="r.keutuhan"></td>
                            <td class="px-4 py-3 font-mono text-foreground dark:text-white whitespace-nowrap" x-text="r.beratTelur"></td>
                        </tr>
                    </template>
                    <tr x-show="sortedRows.length === 0">
                        <td colspan="7" class="px-4 py-8 text-center text-gray-400 italic">Belum ada data scan.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('dashboardData', () => ({
        imagePreview: '{{ uploaded_image or '' }}',
        
        // --- Table Data & Sorting ---
        tableData: {{ records | tojson }},
        sortCol: 'scanned_at',
        sortAsc: false,

        handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                this.imagePreview = URL.createObjectURL(file);
            }
        },

        sortBy(col) {
            if (this.sortCol === col) {
                this.sortAsc = !this.sortAsc;
            } else {
                this.sortCol = col;
                this.sortAsc = true;
            }
        },

        get sortedRows() {
            return this.tableData.sort((a, b) => {
                let valA = a[this.sortCol];
                let valB = b[this.sortCol];
                
                // Handle nulls
                if (valA == null) valA = '';
                if (valB == null) valB = '';

                // Numeric Check
                if (!isNaN(parseFloat(valA)) && isFinite(valA) && !isNaN(parseFloat(valB)) && isFinite(valB)) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return this.sortAsc ? -1 : 1;
                if (valA > valB) return this.sortAsc ? 1 : -1;
                return 0;
            }).slice(0, 10); // Limit top 10
        }
    }));
});
</script>
{% endblock %}