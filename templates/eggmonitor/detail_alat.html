{% extends "eggmonitor/base.html" %}

{% block page_title %}Detail Alat IoT{% endblock %}
{% block page_subtitle %}Monitoring dan kontrol perangkat EggVision secara real-time{% endblock %}

{% block content %}
<div class="space-y-8">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm flex flex-col justify-between transition-colors">
            <div>
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-canela font-bold text-xl text-foreground dark:text-white">Status Koneksi</h3>
                    <span class="relative flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
                    Perangkat ESP32 terhubung ke MQTT Broker dan siap menerima perintah.
                </p>
            </div>
            
            <div class="space-y-3">
                <div class="flex justify-between text-sm border-b border-dashed border-gray-200 dark:border-gray-700 pb-2">
                    <span class="text-gray-500">Broker</span>
                    <span class="font-mono font-bold text-primary">broker.emqx.io</span>
                </div>
                <div class="flex justify-between text-sm border-b border-dashed border-gray-200 dark:border-gray-700 pb-2">
                    <span class="text-gray-500">Port</span>
                    <span class="font-mono font-bold text-foreground dark:text-white">1883</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">Device ID</span>
                    <span class="font-mono font-bold text-foreground dark:text-white">ESP32-EggVision-01</span>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl overflow-hidden shadow-sm h-[400px] relative group transition-colors">
            <div class="absolute top-4 right-4 z-10 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">
                Simulasi Wokwi
            </div>
            <iframe src="{{ wokwi_url }}" 
                    class="w-full h-full border-0 bg-gray-100 dark:bg-[#1a1a1a]" 
                    title="Wokwi Simulation">
            </iframe>
        </div>
    </div>

    <div class="bg-white dark:bg-dark-surface border border-border dark:border-dark-border rounded-2xl p-6 shadow-sm transition-colors">
        <div class="mb-6">
            <h3 class="font-canela font-bold text-2xl text-foreground dark:text-white mb-1">Kontrol Manual</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Kendallikan indikator LED pada alat secara manual untuk pengujian.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" x-data="iotControl">
            
            <div class="p-5 border border-border dark:border-dark-border rounded-xl bg-gray-50 dark:bg-white/5 flex flex-col items-center text-center hover:border-yellow-400 transition-colors">
                <div class="w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900/20 text-yellow-600 flex items-center justify-center mb-3">
                    <i data-lucide="sun" class="w-6 h-6"></i>
                </div>
                <h4 class="font-bold text-foreground dark:text-white mb-1">Light Brown</h4>
                <p class="text-xs text-gray-500 mb-4">Indikator Telur Coklat Muda</p>
                
                <div class="flex items-center gap-3">
                    <button @click="toggleLed('lightbrown', 'on')" 
                            class="px-4 py-2 bg-white dark:bg-black/20 border border-border dark:border-dark-border rounded-lg text-xs font-bold hover:bg-green-50 hover:text-green-600 hover:border-green-200 transition-all active:scale-95">
                        ON
                    </button>
                    <button @click="toggleLed('lightbrown', 'off')" 
                            class="px-4 py-2 bg-white dark:bg-black/20 border border-border dark:border-dark-border rounded-lg text-xs font-bold hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-all active:scale-95">
                        OFF
                    </button>
                </div>
            </div>

            <div class="p-5 border border-border dark:border-dark-border rounded-xl bg-gray-50 dark:bg-white/5 flex flex-col items-center text-center hover:border-orange-400 transition-colors">
                <div class="w-12 h-12 rounded-full bg-orange-100 dark:bg-orange-900/20 text-orange-600 flex items-center justify-center mb-3">
                    <i data-lucide="egg" class="w-6 h-6"></i>
                </div>
                <h4 class="font-bold text-foreground dark:text-white mb-1">Brown</h4>
                <p class="text-xs text-gray-500 mb-4">Indikator Telur Coklat Sedang</p>
                
                <div class="flex items-center gap-3">
                    <button @click="toggleLed('brown', 'on')" 
                            class="px-4 py-2 bg-white dark:bg-black/20 border border-border dark:border-dark-border rounded-lg text-xs font-bold hover:bg-green-50 hover:text-green-600 hover:border-green-200 transition-all active:scale-95">
                        ON
                    </button>
                    <button @click="toggleLed('brown', 'off')" 
                            class="px-4 py-2 bg-white dark:bg-black/20 border border-border dark:border-dark-border rounded-lg text-xs font-bold hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-all active:scale-95">
                        OFF
                    </button>
                </div>
            </div>

            <div class="p-5 border border-border dark:border-dark-border rounded-xl bg-gray-50 dark:bg-white/5 flex flex-col items-center text-center hover:border-amber-700 transition-colors">
                <div class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/20 text-amber-800 flex items-center justify-center mb-3">
                    <i data-lucide="moon" class="w-6 h-6"></i>
                </div>
                <h4 class="font-bold text-foreground dark:text-white mb-1">Dark Brown</h4>
                <p class="text-xs text-gray-500 mb-4">Indikator Telur Coklat Tua</p>
                
                <div class="flex items-center gap-3">
                    <button @click="toggleLed('darkbrown', 'on')" 
                            class="px-4 py-2 bg-white dark:bg-black/20 border border-border dark:border-dark-border rounded-lg text-xs font-bold hover:bg-green-50 hover:text-green-600 hover:border-green-200 transition-all active:scale-95">
                        ON
                    </button>
                    <button @click="toggleLed('darkbrown', 'off')" 
                            class="px-4 py-2 bg-white dark:bg-black/20 border border-border dark:border-dark-border rounded-lg text-xs font-bold hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-all active:scale-95">
                        OFF
                    </button>
                </div>
            </div>

        </div>
        
        <div class="mt-6 p-4 bg-black text-green-400 font-mono text-xs rounded-lg h-32 overflow-y-auto border border-gray-800" id="consoleLog">
            <p class="opacity-50">> System Ready...</p>
            <p class="opacity-50">> Connected to MQTT Broker...</p>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('iotControl', () => ({
            logMessage(msg) {
                const consoleEl = document.getElementById('consoleLog');
                const p = document.createElement('p');
                p.textContent = `> ${msg}`;
                consoleEl.appendChild(p);
                consoleEl.scrollTop = consoleEl.scrollHeight;
            },

            toggleLed(device, state) {
                this.logMessage(`Sending command: ${device} -> ${state.toUpperCase()}...`);
                
                fetch("{{ url_for('eggmonitor_controller.api_wokwi_control') }}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ device: device, state: state })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.ok) {
                        this.logMessage(`Success: ${device} is now ${state.toUpperCase()}`);
                    } else {
                        this.logMessage(`Error: ${data.error}`);
                    }
                })
                .catch(err => {
                    this.logMessage(`Connection Failed: ${err}`);
                });
            }
        }));
    });
</script>
{% endblock %}